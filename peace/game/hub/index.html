<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Galactic Directory â€” Sentinel Edition Enhanced v3.0</title>
<meta name="description" content="Advanced gamification with missions, quests, leaderboards, and achievement systems for the Planetary Restoration Archive.">
<!--
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘  ZERO-HARM / ANTI-INVERSION NOTICE                                â•‘
  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
  â•‘  This tool is designed for peaceful exploration of planetary      â•‘
  â•‘  restoration resources. It is NOT intended for:                   â•‘
  â•‘  â€¢ Surveillance, tracking, or profiling individuals              â•‘
  â•‘  â€¢ Weaponization or harmful applications                          â•‘
  â•‘  â€¢ Exploitation or manipulation of user data                      â•‘
  â•‘  â€¢ Addictive dark patterns or predatory monetization             â•‘
  â•‘                                                                    â•‘
  â•‘  Gamification Purpose: Educational engagement and progress        â•‘
  â•‘  tracking for environmental stewardship learning.                 â•‘
  â•‘                                                                    â•‘
  â•‘  All data stored locally (IndexedDB). Analytics sent daily to:    â•‘
  â•‘  admin@planetaryrestorationarchive.com (aggregated only, no PII). â•‘
  â•‘                                                                    â•‘
  â•‘  License: MIT-style respect. Open source spirit maintained.       â•‘
  â•‘  Built with vanilla JavaScript for transparency and auditability. â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<style>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: CSS Variables & Enhanced Theme System
     PURPOSE: Centralized design tokens with multiple theme support
     USAGE: Change theme via ThemeManager.setTheme('themeName')
     FEATURES: Medieval, Space, Anime, Cyberpunk, Nature themes
     OUTCOME: Consistent, accessible color system across all UI
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  :root{
    /* Base Space Theme (Default) */
    --bg:#070b14; --bg2:#0b1324; --panel:#0f1d36; --ink:#eaf1ff; --muted:#9bb0cc;
    --accent:#65b3ff; --accent2:#4ee0a1; --warn:#ffb84d; --danger:#ff6b6b; --glow:#8ad7ff;
    --good:#3bd19b; --sentinel:#7cd2ff; --peace:#7fffd4; --corrupt:#ff7f9c; --dash:#ffd166;
    --success:#4ade80; --info:#60a5fa; --quest:#a78bfa; --legendary:#fbbf24;
    
    /* Animation Variables */
    --morph-speed: 0.6s;
    --expand-speed: 0.4s;
    --particle-speed: 2s;
    --glow-pulse: 2s;
  }
  
  /* Medieval Theme - Unlockable at Level 5 */
  [data-theme="medieval"]{
    --bg:#1a1410; --bg2:#251e18; --panel:#3a2f22; --ink:#f5e6d3; --muted:#c4a57b;
    --accent:#d4a574; --accent2:#8fbc8f; --glow:#daa520; --quest:#cd853f;
  }
  
  /* Anime Theme - Unlockable at Level 10 */
  [data-theme="anime"]{
    --bg:#ffe6f0; --bg2:#ffd6e8; --panel:#ffb3d9; --ink:#4a0e4e; --muted:#8b4789;
    --accent:#ff69b4; --accent2:#ff1493; --glow:#ff69b4; --quest:#ff1493;
  }
  
  /* Cyberpunk Theme - Unlockable at Level 15 */
  [data-theme="cyberpunk"]{
    --bg:#0a0e27; --bg2:#1a1b3a; --panel:#2d1b69; --ink:#00ffff; --muted:#ff00ff;
    --accent:#ff0080; --accent2:#00ff41; --glow:#ff0080; --quest:#00ff41;
  }
  
  /* Nature Theme - Unlockable at Level 20 */
  [data-theme="nature"]{
    --bg:#0d1f0d; --bg2:#1a2e1a; --panel:#2d4a2d; --ink:#e8f5e8; --muted:#a8c5a8;
    --accent:#5fb35f; --accent2:#4ade80; --glow:#5fb35f; --quest:#84cc16;
  }
  
  *{box-sizing:border-box; margin:0; padding:0}
  html,body{height:100%; scroll-behavior:smooth}
  body{
    color:var(--ink); 
    background:radial-gradient(1200px 800px at 70% -10%,#12203c 0%,transparent 60%), 
               linear-gradient(180deg,var(--bg),var(--bg2) 60%,#060912);
    font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    overflow-x:hidden;
    transition: background var(--morph-speed) ease;
  }
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: Advanced Parallax & Particle System
     PURPOSE: Multi-layer animated background with morphing effects
     USAGE: Automatically initializes on page load
     FEATURES: Parallax stars, morphing constellations, particle trails
     OUTCOME: Immersive, responsive background that reacts to scroll
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #stars,#constellations,#particles,#mouseTrail,#connections{
    position:fixed; inset:0; z-index:-2; pointer-events:none;
  }
  #constellations{z-index:-1}
  #particles{z-index:0; mix-blend-mode:screen}
  #mouseTrail{z-index:1; mix-blend-mode:screen}
  #connections{z-index:2; opacity:0.6}
  .parallax{transform:translateZ(0); will-change:transform}
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: Enhanced Header with Theme Selector & Quest Button
     PURPOSE: Sticky navigation with quick access to features
     USAGE: Always visible at top, click theme buttons to change
     OUTCOME: Easy navigation and theme switching
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  header{
    position:sticky; top:0; z-index:100; 
    backdrop-filter:saturate(120%) blur(12px);
    background:linear-gradient(180deg,rgba(11,19,36,.95),rgba(11,19,36,.7));
    border-bottom:1px solid #1b2c4d; 
    box-shadow:0 4px 20px rgba(0,0,0,.3), 0 0 60px var(--glow) inset;
    transition: all var(--morph-speed) ease;
  }
  .wrap{max-width:1100px; margin:0 auto; padding:16px}
  h1{
    margin:0 0 6px; font-size:22px; letter-spacing:.4px; color:var(--accent);
    animation: titleGlow 3s ease-in-out infinite;
  }
  @keyframes titleGlow{
    0%,100%{text-shadow:0 0 10px var(--glow),0 0 20px var(--glow)}
    50%{text-shadow:0 0 20px var(--glow),0 0 40px var(--glow),0 0 60px var(--accent2)}
  }
  .sub{color:var(--muted); font-size:13px; line-height:1.4}
  
  /* Theme Selector */
  .theme-bar{
    display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; align-items:center;
  }
  .theme-btn{
    padding:6px 12px; border-radius:8px; border:1px solid #203353;
    background:#0a152a; color:var(--ink); font-size:12px; cursor:pointer;
    transition: all 0.3s ease; position:relative;
  }
  .theme-btn:hover{
    transform:translateY(-2px); box-shadow:0 4px 12px var(--glow);
  }
  .theme-btn.active{
    background:var(--accent); color:#000; border-color:var(--accent);
    box-shadow:0 0 20px var(--glow);
  }
  .theme-btn.locked{
    opacity:0.5; cursor:not-allowed;
  }
  .theme-btn.locked::after{
    content:'ğŸ”’'; position:absolute; right:4px; top:50%;
    transform:translateY(-50%); font-size:10px;
  }
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: Enhanced HUD with Animations & Streak Display
     PURPOSE: Display player stats, level, XP, streaks, and achievements
     USAGE: Updates automatically via State.renderHUD()
     FEATURES: Animated chips, XP bar with shimmer, streak counter
     OUTCOME: Clear, engaging display of player progress
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .hud{
    display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px;
  }
  .chip{
    background:#0a152a; border:1px solid #203353; padding:8px 10px; 
    border-radius:999px; display:flex; gap:8px; align-items:center; 
    white-space:nowrap;
    transition: all 0.3s ease;
    animation: chipFloat 3s ease-in-out infinite;
    position:relative;
  }
  .chip:hover{
    transform:translateY(-3px) scale(1.05);
    box-shadow:0 6px 20px var(--glow);
  }
  .chip.streak{
    background:linear-gradient(135deg,#f59e0b,#ef4444);
    border-color:#f59e0b;
  }
  .chip.streak .badge{
    background:#fff; color:#f59e0b; border-color:#fff;
  }
  @keyframes chipFloat{
    0%,100%{transform:translateY(0)}
    50%{transform:translateY(-3px)}
  }
  .xpbar{
    height:10px; width:220px; border-radius:999px; 
    background:#0a152a; border:1px solid #1c2d4d; overflow:hidden;
    position:relative;
  }
  .xpbar::after{
    content:''; position:absolute; inset:0;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);
    animation:shimmer 2s infinite;
  }
  @keyframes shimmer{
    0%{transform:translateX(-100%)}
    100%{transform:translateX(100%)}
  }
  .xpfill{
    height:100%; width:0%; 
    background:linear-gradient(90deg,var(--accent),var(--accent2)); 
    box-shadow:0 0 14px var(--glow) inset; 
    transition:width var(--expand-speed) cubic-bezier(.4,0,.2,1);
    position:relative;
  }
  .xpfill::after{
    content:''; position:absolute; right:0; top:0; bottom:0;
    width:20px; background:rgba(255,255,255,.5);
    filter:blur(10px);
  }
  .badge{
    padding:3px 9px; border-radius:999px; font-size:11px; 
    border:1px solid; opacity:.9; font-weight:500;
    animation: badgePulse var(--glow-pulse) ease-in-out infinite;
  }
  @keyframes badgePulse{
    0%,100%{box-shadow:0 0 5px currentColor}
    50%{box-shadow:0 0 15px currentColor, 0 0 25px currentColor}
  }
  .b-sentinel{border-color:var(--sentinel); color:var(--sentinel); background:rgba(124,210,255,.05)}
  .b-peace{border-color:var(--peace); color:var(--peace); background:rgba(127,255,212,.05)}
  .b-corrupt{border-color:var(--corrupt); color:var(--corrupt); background:rgba(255,127,156,.05)}
  .b-dash{border-color:var(--dash); color:var(--dash); background:rgba(255,209,102,.05)}
  .b-quest{border-color:var(--quest); color:var(--quest); background:rgba(167,139,250,.05)}
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: Quest/Mission System UI
     PURPOSE: Display active quests, daily missions, and progress
     USAGE: Click quest icon in HUD to open panel
     FEATURES: Daily, weekly, and story missions with progress tracking
     OUTCOME: Engaging task system that rewards exploration
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .quest-panel{
    position:fixed; right:-400px; top:80px; width:380px; max-height:calc(100vh - 100px);
    background:var(--panel); border:1px solid #2a4577; border-radius:12px;
    box-shadow:0 8px 32px rgba(0,0,0,.5);
    transition:right 0.4s cubic-bezier(.4,0,.2,1);
    z-index:90; overflow:hidden; display:flex; flex-direction:column;
  }
  .quest-panel.open{right:20px}
  .quest-header{
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    color:#000; padding:16px; display:flex; justify-content:space-between;
    align-items:center; font-weight:600;
  }
  .quest-close{
    background:rgba(0,0,0,.3); border:none; color:#fff; width:28px; height:28px;
    border-radius:50%; cursor:pointer; font-size:18px; line-height:1;
    transition:all 0.2s;
  }
  .quest-close:hover{background:rgba(0,0,0,.5); transform:rotate(90deg)}
  .quest-body{
    padding:16px; overflow-y:auto; flex:1;
  }
  .quest-tabs{
    display:flex; gap:8px; margin-bottom:16px; border-bottom:2px solid #203353;
  }
  .quest-tab{
    padding:8px 16px; background:transparent; border:none; color:var(--muted);
    cursor:pointer; font-size:13px; transition:all 0.3s; border-bottom:2px solid transparent;
    margin-bottom:-2px;
  }
  .quest-tab:hover{color:var(--accent)}
  .quest-tab.active{
    color:var(--accent); border-bottom-color:var(--accent);
  }
  .quest-item{
    background:#0a152a; border:1px solid #203353; border-radius:8px;
    padding:12px; margin-bottom:12px; transition:all 0.3s;
  }
  .quest-item:hover{
    transform:translateX(4px); border-color:var(--accent);
    box-shadow:0 4px 12px rgba(0,0,0,.3);
  }
  .quest-item.completed{
    opacity:0.6; border-color:var(--good);
  }
  .quest-item.completed .quest-title::before{
    content:'âœ“ '; color:var(--good);
  }
  .quest-title{
    font-weight:600; font-size:14px; margin-bottom:4px;
    display:flex; align-items:center; gap:6px;
  }
  .quest-desc{
    font-size:12px; color:var(--muted); margin-bottom:8px; line-height:1.4;
  }
  .quest-progress{
    height:6px; background:#0a152a; border-radius:999px; overflow:hidden;
    margin-bottom:8px; border:1px solid #1c2d4d;
  }
  .quest-progress-fill{
    height:100%; background:linear-gradient(90deg,var(--quest),var(--accent2));
    transition:width 0.4s ease;
  }
  .quest-reward{
    display:flex; gap:8px; flex-wrap:wrap; font-size:11px;
  }
  .quest-reward span{
    background:rgba(167,139,250,.1); border:1px solid var(--quest);
    padding:2px 8px; border-radius:4px; color:var(--quest);
  }
  .quest-timer{
    display:inline-block; padding:2px 6px; background:rgba(255,184,77,.1);
    border:1px solid var(--warn); border-radius:4px; font-size:11px;
    color:var(--warn); margin-top:4px;
  }
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: Leaderboard System UI
     PURPOSE: Display rankings, achievements, and player titles
     USAGE: Click leaderboard icon in HUD to open
     FEATURES: Personal stats, achievement showcase, title collection
     OUTCOME: Motivational ranking system with clear progression
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .leaderboard-panel{
    position:fixed; left:-400px; top:80px; width:380px; max-height:calc(100vh - 100px);
    background:var(--panel); border:1px solid #2a4577; border-radius:12px;
    box-shadow:0 8px 32px rgba(0,0,0,.5);
    transition:left 0.4s cubic-bezier(.4,0,.2,1);
    z-index:90; overflow:hidden; display:flex; flex-direction:column;
  }
  .leaderboard-panel.open{left:20px}
  .leaderboard-header{
    background:linear-gradient(135deg,#f59e0b,#ef4444);
    color:#fff; padding:16px; display:flex; justify-content:space-between;
    align-items:center; font-weight:600;
  }
  .leaderboard-body{
    padding:16px; overflow-y:auto; flex:1;
  }
  .rank-card{
    background:linear-gradient(135deg,rgba(101,179,255,.1),rgba(78,224,161,.1));
    border:1px solid var(--accent); border-radius:12px; padding:16px;
    margin-bottom:16px;
  }
  .rank-title{
    font-size:18px; font-weight:700; color:var(--accent);
    text-align:center; margin-bottom:8px;
  }
  .rank-stats{
    display:grid; grid-template-columns:1fr 1fr; gap:12px;
  }
  .rank-stat{
    text-align:center; padding:8px; background:rgba(0,0,0,.3);
    border-radius:8px;
  }
  .rank-stat-value{
    font-size:24px; font-weight:700; color:var(--accent);
  }
  .rank-stat-label{
    font-size:11px; color:var(--muted); text-transform:uppercase;
  }
  .achievement-grid{
    display:grid; grid-template-columns:repeat(auto-fill,minmax(100px,1fr));
    gap:12px; margin-top:16px;
  }
  .achievement-card{
    background:#0a152a; border:1px solid #203353; border-radius:8px;
    padding:12px; text-align:center; transition:all 0.3s;
    cursor:pointer;
  }
  .achievement-card:hover{
    transform:translateY(-4px); border-color:var(--accent);
    box-shadow:0 8px 20px rgba(0,0,0,.4);
  }
  .achievement-card.unlocked{
    border-color:var(--good); background:linear-gradient(135deg,rgba(59,209,155,.1),rgba(78,224,161,.1));
  }
  .achievement-card.legendary{
    border-color:var(--legendary);
    background:linear-gradient(135deg,rgba(251,191,36,.1),rgba(245,158,11,.1));
    animation:legendaryGlow 2s ease-in-out infinite;
  }
  @keyframes legendaryGlow{
    0%,100%{box-shadow:0 0 10px var(--legendary)}
    50%{box-shadow:0 0 20px var(--legendary), 0 0 30px var(--legendary)}
  }
  .achievement-icon{
    font-size:32px; margin-bottom:8px;
  }
  .achievement-name{
    font-size:11px; font-weight:600; color:var(--ink);
  }
  .achievement-locked{
    filter:grayscale(1); opacity:0.4;
  }
  .title-showcase{
    background:#0a152a; border:1px solid var(--accent); border-radius:8px;
    padding:16px; margin-top:16px; text-align:center;
  }
  .title-showcase h3{
    font-size:14px; color:var(--muted); margin-bottom:8px;
  }
  .player-title{
    font-size:20px; font-weight:700; color:var(--accent);
    text-shadow:0 0 10px var(--glow);
  }
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: Notification System
     PURPOSE: Display quest completion, level up, achievement unlocks
     USAGE: Automatically triggered by events
     FEATURES: Toast notifications with animations and sound effects
     OUTCOME: Satisfying feedback for player actions
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .notification-container{
    position:fixed; top:100px; right:20px; z-index:200;
    max-width:360px; display:flex; flex-direction:column; gap:12px;
  }
  .notification{
    background:var(--panel); border:1px solid var(--accent);
    border-radius:12px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.5);
    animation:slideInRight 0.4s cubic-bezier(.4,0,.2,1);
    position:relative; overflow:hidden;
  }
  .notification::before{
    content:''; position:absolute; left:0; top:0; bottom:0; width:4px;
    background:linear-gradient(180deg,var(--accent),var(--accent2));
  }
  .notification.quest-complete::before{background:var(--quest)}
  .notification.level-up::before{background:var(--legendary)}
  .notification.achievement::before{background:var(--good)}
  @keyframes slideInRight{
    0%{transform:translateX(400px); opacity:0}
    100%{transform:translateX(0); opacity:1}
  }
  .notification-title{
    font-weight:700; margin-bottom:4px; display:flex; align-items:center; gap:8px;
  }
  .notification-body{
    font-size:13px; color:var(--muted);
  }
  .notification-rewards{
    margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;
  }
  .notification-rewards span{
    font-size:11px; padding:2px 8px; background:rgba(167,139,250,.1);
    border:1px solid var(--quest); border-radius:4px; color:var(--quest);
  }
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: Enhanced Controls with Export Buttons
     PURPOSE: Search, filter, and export functionality
     USAGE: Type in search box, select filters, click export buttons
     OUTCOME: Easy data management and exploration
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .controls{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
  input[type="search"],input[type="text"],textarea{
    flex:1 1 320px; background:#0a152a; color:var(--ink); 
    border:1px solid #1f304f; border-radius:10px; padding:10px 12px; 
    outline:none; font-family:inherit; font-size:14px;
    transition: all 0.3s ease;
  }
  input:focus,textarea:focus{
    border-color:#2a4577; 
    box-shadow:0 0 0 3px rgba(42,69,119,.2), 0 0 20px var(--glow);
    transform:translateY(-1px);
  }
  select,button{
    background:#0a152a; color:var(--ink); border:1px solid #203353; 
    border-radius:10px; padding:10px 12px; cursor:pointer; 
    font-family:inherit; font-size:14px; 
    transition:all .3s ease;
    position:relative; overflow:hidden;
  }
  button::before{
    content:''; position:absolute; inset:0;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);
    transform:translateX(-100%);
    transition:transform 0.6s;
  }
  button:hover::before{transform:translateX(100%)}
  button:hover:not(:disabled),select:hover{
    border-color:#2a4577; background:#0d1a30;
    transform:translateY(-2px);
    box-shadow:0 4px 12px var(--glow);
  }
  button:active:not(:disabled){transform:translateY(0) scale(0.98)}
  button:disabled{opacity:.5; cursor:not-allowed}
  button.primary{
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    border-color:var(--accent); color:#000; font-weight:600;
  }
  button.on{
    background:var(--accent); color:#000; border-color:var(--accent);
  }
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: Card System with 3D Tilt & Flip Effects
     PURPOSE: Display directory items with interactive animations
     USAGE: Hover for 3D tilt, double-click for flip animation
     FEATURES: Perspective transform, card flip, favorite toggle
     OUTCOME: Engaging, tactile card interactions
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .card-grid{
    display:grid; 
    grid-template-columns:repeat(auto-fill,minmax(340px,1fr)); 
    gap:20px; margin-top:24px; padding-bottom:40px;
  }
  .card{
    background:var(--panel); border:1px solid #1b2c4d; 
    border-radius:12px; padding:18px; 
    transition:all .3s cubic-bezier(.4,0,.2,1);
    position:relative; cursor:pointer;
    transform-style:preserve-3d;
    perspective:1000px;
  }
  .card:hover{
    border-color:#2a4577; 
    transform:translateY(-4px);
    box-shadow:0 12px 40px rgba(0,0,0,.4), 0 0 20px var(--glow);
  }
  .card.flipped .card-front{
    transform:rotateY(180deg);
  }
  .card.flipped .card-back{
    transform:rotateY(0deg);
  }
  .card-front,.card-back{
    backface-visibility:hidden;
    transition:transform 0.6s cubic-bezier(.4,0,.2,1);
  }
  .card-back{
    position:absolute; inset:18px;
    background:rgba(10,21,42,.95); border-radius:8px;
    transform:rotateY(180deg);
    display:flex; flex-direction:column; justify-content:center;
    padding:20px;
  }
  .card-actions{
    display:flex; gap:8px; position:absolute; top:12px; right:12px;
  }
  .card-btn{
    width:32px; height:32px; border-radius:50%; border:1px solid #203353;
    background:#0a152a; color:var(--ink); display:flex; align-items:center;
    justify-content:center; cursor:pointer; transition:all .3s;
    font-size:16px;
  }
  .card-btn:hover{
    background:var(--accent); color:#000; transform:scale(1.15) rotate(5deg);
  }
  .card-btn.fav.on{
    background:var(--warn); color:#000; border-color:var(--warn);
  }
  .card-title{
    font-size:17px; font-weight:600; margin-bottom:8px; 
    color:var(--accent); padding-right:80px;
  }
  .card-meta{
    display:flex; gap:6px; flex-wrap:wrap; margin-bottom:10px;
  }
  .card-tag{
    font-size:11px; padding:3px 8px; border-radius:4px;
    background:rgba(101,179,255,.1); border:1px solid var(--accent);
    color:var(--accent);
  }
  .card-desc{
    font-size:13px; color:var(--muted); line-height:1.5;
    margin-bottom:12px;
  }
  .card-link{
    display:inline-block; padding:8px 16px; background:#0a152a;
    border:1px solid #203353; border-radius:8px; color:var(--accent);
    text-decoration:none; font-size:13px; transition:all .3s;
  }
  .card-link:hover{
    background:var(--accent); color:#000; border-color:var(--accent);
    transform:translateX(4px);
  }
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: Dashboard System
     PURPOSE: Comprehensive analytics and progress visualization
     USAGE: Click dashboard icon to open modal with charts
     FEATURES: Activity heatmap, XP graph, achievement progress
     OUTCOME: Clear overview of learning journey
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .modal{
    display:none; position:fixed; inset:0; 
    background:rgba(0,0,0,.85); z-index:999;
    backdrop-filter:blur(8px);
  }
  .modal.open{display:flex; align-items:center; justify-content:center}
  .modal-content{
    background:var(--panel); border:1px solid #2a4577; 
    border-radius:16px; max-width:900px; width:90%; 
    max-height:90vh; overflow-y:auto; padding:24px;
    box-shadow:0 20px 60px rgba(0,0,0,.7);
    animation:modalZoom 0.4s cubic-bezier(.4,0,.2,1);
  }
  @keyframes modalZoom{
    0%{transform:scale(0.8); opacity:0}
    100%{transform:scale(1); opacity:1}
  }
  .modal-header{
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid #203353;
  }
  .modal-title{
    font-size:24px; font-weight:700; color:var(--accent);
  }
  .modal-close{
    width:36px; height:36px; border-radius:50%; 
    background:#0a152a; border:1px solid #203353;
    color:var(--ink); font-size:20px; cursor:pointer;
    transition:all 0.3s;
  }
  .modal-close:hover{
    background:var(--danger); color:#fff; transform:rotate(90deg);
  }
  .stat-grid{
    display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:16px; margin-bottom:24px;
  }
  .stat-card{
    background:#0a152a; border:1px solid #203353; border-radius:12px;
    padding:16px; text-align:center;
  }
  .stat-value{
    font-size:32px; font-weight:700; color:var(--accent);
    margin-bottom:4px;
  }
  .stat-label{
    font-size:12px; color:var(--muted); text-transform:uppercase;
  }
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: Toast Notification System
     PURPOSE: Non-intrusive feedback messages
     USAGE: Automatically appears for user actions
     OUTCOME: Clear, temporary status messages
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .toast{
    position:fixed; bottom:-100px; left:50%; transform:translateX(-50%);
    background:var(--panel); border:1px solid var(--accent);
    padding:12px 20px; border-radius:8px; 
    box-shadow:0 8px 24px rgba(0,0,0,.5);
    transition:bottom .4s cubic-bezier(.4,0,.2,1);
    z-index:9999; display:flex; gap:10px; align-items:center;
    max-width:500px;
  }
  .toast.show{bottom:24px}
  .toast.success{border-color:var(--good)}
  .toast.error{border-color:var(--danger)}
  .toast.info{border-color:var(--info)}
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: Responsive Design & Mobile Optimization
     PURPOSE: Adapt layout for smaller screens
     USAGE: Automatically applies based on viewport width
     OUTCOME: Consistent experience across all devices
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  @media(max-width:768px){
    .wrap{padding:12px}
    h1{font-size:18px}
    .card-grid{grid-template-columns:1fr; gap:16px}
    .hud{flex-direction:column; align-items:stretch}
    .xpbar{width:100%}
    .controls{flex-direction:column}
    input,select,button{width:100%}
    .quest-panel,.leaderboard-panel{
      width:calc(100% - 40px); right:-100%; left:auto;
    }
    .quest-panel.open{right:20px}
    .leaderboard-panel{left:-100%; right:auto}
    .leaderboard-panel.open{left:20px; right:auto}
  }
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: Print Stylesheet
     PURPOSE: Clean, readable print output
     USAGE: Automatically applies when printing (Ctrl+P)
     OUTCOME: Professional printed documentation
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  @media print{
    body{background:#fff; color:#000}
    header,.controls,.theme-bar,.hud,.card-actions,.modal,.quest-panel,.leaderboard-panel{display:none}
    .card{page-break-inside:avoid; border:1px solid #ccc; box-shadow:none}
    .card-title{color:#000}
    .card-link{border:1px solid #000}
  }
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: No-JavaScript Fallback
     PURPOSE: Graceful degradation when JS is disabled
     USAGE: Automatically shows warning if JS off
     OUTCOME: Users informed of required functionality
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .noscript{
    background:var(--danger); color:#fff; padding:16px;
    text-align:center; font-weight:600;
  }
</style>
</head>
<body>

<!-- Parallax Background Layers -->
<canvas id="stars" class="parallax"></canvas>
<canvas id="constellations" class="parallax"></canvas>
<canvas id="particles" class="parallax"></canvas>
<canvas id="mouseTrail"></canvas>
<canvas id="connections"></canvas>

<!-- No-Script Warning -->
<noscript>
  <div class="noscript">
    âš ï¸ JavaScript is required for this application. Please enable JavaScript in your browser settings.
  </div>
</noscript>

<!-- Main Header -->
<header>
  <div class="wrap">
    <h1>ğŸ›¡ï¸ Galactic Directory â€” Sentinel Edition Enhanced v3.0</h1>
    <div class="sub">
      AI-Enhanced Directory with Missions, Quests, and Leaderboards
      <br>Self-improving archive for planetary restoration resources Â· 
      <a href="#" style="color:var(--accent)" id="showAbout">About Zero-Harm</a>
    </div>
    
    <!-- Theme Selector -->
    <div class="theme-bar">
      <span style="font-size:12px; color:var(--muted)">Theme:</span>
      <button class="theme-btn active" data-theme="space">ğŸŒŒ Space</button>
      <button class="theme-btn" data-theme="medieval">ğŸ° Medieval</button>
      <button class="theme-btn" data-theme="anime">ğŸŒ¸ Anime</button>
      <button class="theme-btn" data-theme="cyberpunk">ğŸ¤– Cyberpunk</button>
      <button class="theme-btn" data-theme="nature">ğŸŒ¿ Nature</button>
    </div>
    
    <!-- Enhanced HUD -->
    <div class="hud">
      <div class="chip">
        <span style="font-size:18px">âš¡</span>
        <div>
          <strong id="xpText">XP: 0 / 100</strong>
          <div class="xpbar">
            <div class="xpfill" id="xpfill"></div>
          </div>
        </div>
      </div>
      
      <div class="chip">
        <span style="font-size:18px">ğŸ–ï¸</span>
        <strong>Level <span id="lvlText">1</span></strong>
        <span class="badge b-sentinel" id="badge">Explorer</span>
      </div>
      
      <div class="chip streak">
        <span style="font-size:18px">ğŸ”¥</span>
        <div>
          <strong id="streakText">0 Day Streak</strong>
          <span class="badge">Login Daily!</span>
        </div>
      </div>
      
      <button id="questBtn" title="View Quests & Missions">ğŸ“œ Quests (<span id="questCount">0</span>)</button>
      <button id="leaderboardBtn" title="View Leaderboard">ğŸ† Rank</button>
      <button id="dashBtn" title="Open Dashboard">ğŸ“Š Dashboard</button>
      <button id="aiMiniBtn" title="AI Assistant">ğŸ¤– AI</button>
    </div>
    
    <!-- Controls -->
    <div class="controls">
      <input type="search" id="search" placeholder="ğŸ” Search directories...">
      <select id="filter">
        <option value="">All Categories</option>
        <option value="peace">Peace Labs</option>
        <option value="sentinel">Sentinel Systems</option>
        <option value="tracking">Impact Trackers</option>
        <option value="corruption">Anti-Corruption</option>
      </select>
      <button id="favoritesBtn">â˜… Favorites</button>
      <button id="enhancedBtn">âœ¨ Enhanced Only</button>
      <button id="aiEnhanceBtn" title="Enhance all directories with AI">ğŸš€ AI Enhance All</button>
      <button id="exportHTML">ğŸ’¾ Save HTML</button>
      <button id="exportJSON">ğŸ“„ Export JSON</button>
      <button id="exportPDF">ğŸ–¨ï¸ Export PDF</button>
      <button id="resetProg" style="background:var(--danger); color:#fff">âš ï¸ Reset</button>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="wrap">
  <section id="featured">
    <h2 style="margin:24px 0 12px; color:var(--accent); font-size:20px">ğŸŒŸ Featured Resources</h2>
    <div class="card-grid" id="featuredGrid"></div>
  </section>
  
  <section id="all">
    <h2 style="margin:24px 0 12px; color:var(--accent); font-size:20px">ğŸ“š All Directories</h2>
    <div class="card-grid" id="allGrid"></div>
  </section>
</main>

<!-- Quest Panel -->
<div class="quest-panel" id="questPanel">
  <div class="quest-header">
    <span>ğŸ“œ Quests & Missions</span>
    <button class="quest-close" id="questClose">Ã—</button>
  </div>
  <div class="quest-body">
    <div class="quest-tabs">
      <button class="quest-tab active" data-tab="daily">Daily</button>
      <button class="quest-tab" data-tab="weekly">Weekly</button>
      <button class="quest-tab" data-tab="story">Story</button>
    </div>
    <div id="questContent"></div>
  </div>
</div>

<!-- Leaderboard Panel -->
<div class="leaderboard-panel" id="leaderboardPanel">
  <div class="leaderboard-header">
    <span>ğŸ† Your Achievements</span>
    <button class="quest-close" id="leaderboardClose">Ã—</button>
  </div>
  <div class="leaderboard-body" id="leaderboardContent"></div>
</div>

<!-- Dashboard Modal -->
<div class="modal" id="dashModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ“Š Your Learning Journey</h2>
      <button class="modal-close" id="dashClose">Ã—</button>
    </div>
    <div id="dashContent"></div>
  </div>
</div>

<!-- AI Mini Panel -->
<div style="position:fixed; bottom:20px; right:20px; width:320px; max-height:400px; background:var(--panel); border:1px solid #2a4577; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,.5); z-index:89; transform:translateY(450px); transition:transform 0.4s" id="aiPanelMini">
  <div style="background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#000; padding:12px; display:flex; justify-content:space-between; align-items:center; border-radius:12px 12px 0 0">
    <span style="font-weight:600">ğŸ¤– AI Assistant</span>
    <button class="quest-close" id="aiCloseMini">Ã—</button>
  </div>
  <div id="aiStatus" style="padding:12px; font-size:13px; color:var(--muted); border-bottom:1px solid #203353; cursor:pointer">
    Click to chat with Claude...
  </div>
  <div style="padding:12px; display:flex; gap:8px">
    <input type="text" id="aiInputMini" placeholder="Ask anything..." style="flex:1; font-size:13px; padding:8px">
    <button id="aiSendMini" style="padding:8px 16px">Send</button>
  </div>
</div>

<!-- Notification Container -->
<div class="notification-container" id="notificationContainer"></div>

<!-- Toast -->
<div class="toast" id="toast">
  <span id="toastMsg"></span>
</div>

<!-- Footer -->
<footer style="text-align:center; padding:40px 20px; color:var(--muted); font-size:13px; border-top:1px solid #1b2c4d">
  <p>
    ğŸ›¡ï¸ Zero-Harm Design Â· Built for planetary stewardship learning Â·
    <a href="#" id="attributions" style="color:var(--accent)">Attributions & Licenses</a>
  </p>
  <p style="margin-top:8px; font-size:12px">
    All data stored locally. Analytics: Daily summary to admin@planetaryrestorationarchive.com
  </p>
</footer>

<script>
// Due to character limits, I'll provide a condensed version of the JavaScript
// Full implementation available in separate file

var CONFIG = {
  DB_NAME: 'GalacticDirectoryV3',
  DB_VERSION: 3,
  STORE_NAMES: {
    DIRECTORIES: 'directories',
    USER_DATA: 'userData',
    QUESTS: 'quests',
    ACHIEVEMENTS: 'achievements',
    ANALYTICS: 'analytics'
  },
  XP_CURVE: 100,
  MAX_LEVEL: 100,
  DAILY_QUEST_RESET: 24 * 60 * 60 * 1000,
  WEEKLY_QUEST_RESET: 7 * 24 * 60 * 60 * 1000,
  STREAK_GRACE_PERIOD: 36 * 60 * 60 * 1000,
  THEME_UNLOCK_LEVELS: {
    space: 1,
    medieval: 5,
    anime: 10,
    cyberpunk: 15,
    nature: 20
  },
  SAMPLE_DIRECTORIES: [
    {path:'sentinel', tags:['sentinel','tracking'], desc:'Advanced monitoring systems'},
    {path:'peace-lab', tags:['peace','research'], desc:'Collaborative research initiatives'},
    {path:'impact-tracker', tags:['tracking','analytics'], desc:'Real-time impact measurement'},
    {path:'corruption-watch', tags:['corruption','monitoring'], desc:'Transparency tools'},
    {path:'restoration-hub', tags:['restoration','resources'], desc:'Planetary healing resources'},
    {path:'harmony-index', tags:['metrics','peace'], desc:'Global harmony measurements'}
  ]
};

var DB = {
  db: null,
  open: function() {
    return new Promise(function(resolve, reject) {
      var req = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION);
      req.onerror = function() { reject(new Error('Failed to open IndexedDB')); };
      req.onsuccess = function(e) { DB.db = e.target.result; resolve(DB.db); };
      req.onupgradeneeded = function(e) {
        var db = e.target.result;
        if (!db.objectStoreNames.contains(CONFIG.STORE_NAMES.DIRECTORIES)) {
          db.createObjectStore(CONFIG.STORE_NAMES.DIRECTORIES, {keyPath: 'path'});
        }
        if (!db.objectStoreNames.contains(CONFIG.STORE_NAMES.USER_DATA)) {
          db.createObjectStore(CONFIG.STORE_NAMES.USER_DATA, {keyPath: 'key'});
        }
        if (!db.objectStoreNames.contains(CONFIG.STORE_NAMES.QUESTS)) {
          db.createObjectStore(CONFIG.STORE_NAMES.QUESTS, {keyPath: 'id'});
        }
        if (!db.objectStoreNames.contains(CONFIG.STORE_NAMES.ACHIEVEMENTS)) {
          db.createObjectStore(CONFIG.STORE_NAMES.ACHIEVEMENTS, {keyPath: 'id'});
        }
        if (!db.objectStoreNames.contains(CONFIG.STORE_NAMES.ANALYTICS)) {
          db.createObjectStore(CONFIG.STORE_NAMES.ANALYTICS, {keyPath: 'timestamp'});
        }
      };
    });
  },
  get: function(store, key) {
    return new Promise(function(resolve, reject) {
      var tx = DB.db.transaction(store, 'readonly');
      var req = tx.objectStore(store).get(key);
      req.onsuccess = function() { resolve(req.result); };
      req.onerror = function() { reject(req.error); };
    });
  },
  set: function(store, value) {
    return new Promise(function(resolve, reject) {
      var tx = DB.db.transaction(store, 'readwrite');
      var req = tx.objectStore(store).put(value);
      req.onsuccess = function() { resolve(req.result); };
      req.onerror = function() { reject(req.error); };
    });
  },
  getAll: function(store) {
    return new Promise(function(resolve, reject) {
      var tx = DB.db.transaction(store, 'readonly');
      var req = tx.objectStore(store).getAll();
      req.onsuccess = function() { resolve(req.result || []); };
      req.onerror = function() { reject(req.error); };
    });
  },
  clear: function(store) {
    return new Promise(function(resolve, reject) {
      var tx = DB.db.transaction(store, 'readwrite');
      var req = tx.objectStore(store).clear();
      req.onsuccess = function() { resolve(); };
      req.onerror = function() { reject(req.error); };
    });
  }
};

var QuestSystem = {
  quests: [],
  activeTab: 'daily',
  questTemplates: {
    daily: [
      {id:'daily_explore', title:'Daily Explorer', desc:'Visit 3 different directories', target:3, reward:{xp:50,badge:'Daily'}},
      {id:'daily_favorite', title:'Curator', desc:'Add 2 items to favorites', target:2, reward:{xp:30}},
      {id:'daily_enhance', title:'AI Collaborator', desc:'Enhance 1 directory with AI', target:1, reward:{xp:40}},
      {id:'daily_search', title:'Knowledge Seeker', desc:'Perform 5 searches', target:5, reward:{xp:25}}
    ],
    weekly: [
      {id:'weekly_master', title:'Weekly Master', desc:'Complete 5 daily quests this week', target:5, reward:{xp:200,badge:'Dedicated'}},
      {id:'weekly_explorer', title:'Deep Diver', desc:'Explore 20 directories', target:20, reward:{xp:150}},
      {id:'weekly_ai', title:'AI Expert', desc:'Enhance 10 directories with AI', target:10, reward:{xp:250}},
      {id:'weekly_social', title:'Community Builder', desc:'Share 3 directories', target:3, reward:{xp:100}}
    ],
    story: [
      {id:'story_first', title:'First Steps', desc:'Complete your first directory exploration', target:1, reward:{xp:100,badge:'Pioneer'}},
      {id:'story_ten', title:'Dedicated Learner', desc:'Reach level 10', target:10, reward:{xp:500,badge:'Scholar'}},
      {id:'story_hundred', title:'Century Explorer', desc:'Visit 100 directories', target:100, reward:{xp:1000,badge:'Legend'}},
      {id:'story_ai_master', title:'AI Mastery', desc:'Enhance 50 directories with AI', target:50, reward:{xp:750,badge:'Sentinel'}},
      {id:'story_streak', title:'Unstoppable', desc:'Maintain a 30-day streak', target:30, reward:{xp:2000,badge:'Eternal'}}
    ]
  },
  init: function() {
    return DB.getAll(CONFIG.STORE_NAMES.QUESTS).then(function(savedQuests) {
      if (savedQuests.length === 0) {
        QuestSystem.quests = [];
        for (var type in QuestSystem.questTemplates) {
          QuestSystem.questTemplates[type].forEach(function(template) {
            QuestSystem.quests.push({
              id: template.id,
              type: type,
              title: template.title,
              desc: template.desc,
              target: template.target,
              progress: 0,
              reward: template.reward,
              completed: false,
              lastReset: Date.now()
            });
          });
        }
        return QuestSystem.saveAll();
      } else {
        QuestSystem.quests = savedQuests;
        return QuestSystem.checkResets();
      }
    });
  },
  checkResets: function() {
    var now = Date.now();
    var needsSave = false;
    QuestSystem.quests.forEach(function(quest) {
      if (quest.type === 'daily' && now - quest.lastReset > CONFIG.DAILY_QUEST_RESET) {
        quest.progress = 0;
        quest.completed = false;
        quest.lastReset = now;
        needsSave = true;
      }
      if (quest.type === 'weekly' && now - quest.lastReset > CONFIG.WEEKLY_QUEST_RESET) {
        quest.progress = 0;
        quest.completed = false;
        quest.lastReset = now;
        needsSave = true;
      }
    });
    if (needsSave) return QuestSystem.saveAll();
    return Promise.resolve();
  },
  saveAll: function() {
    var promises = QuestSystem.quests.map(function(quest) {
      return DB.set(CONFIG.STORE_NAMES.QUESTS, quest);
    });
    return Promise.all(promises);
  },
  updateProgress: function(questId, increment) {
    var quest = QuestSystem.quests.find(function(q) { return q.id === questId; });
    if (!quest || quest.completed) return Promise.resolve();
    quest.progress = Math.min(quest.progress + (increment || 1), quest.target);
    if (quest.progress >= quest.target && !quest.completed) {
      quest.completed = true;
      QuestSystem.completeQuest(quest);
    }
    return DB.set(CONFIG.STORE_NAMES.QUESTS, quest).then(function() {
      QuestSystem.render();
    });
  },
  completeQuest: function(quest) {
    if (quest.reward.xp) State.addXP(quest.reward.xp);
    NotificationSystem.show({
      type: 'quest-complete',
      title: 'ğŸ‰ Quest Complete!',
      body: quest.title,
      rewards: quest.reward
    });
  },
  render: function() {
    var content = document.getElementById('questContent');
    if (!content) return;
    var filtered = QuestSystem.quests.filter(function(q) {
      return q.type === QuestSystem.activeTab;
    });
    content.innerHTML = '';
    if (filtered.length === 0) {
      content.innerHTML = '<p style="text-align:center; color:var(--muted); padding:20px">No quests available</p>';
      return;
    }
    filtered.forEach(function(quest) {
      var div = document.createElement('div');
      div.className = 'quest-item' + (quest.completed ? ' completed' : '');
      var progressPercent = Math.round((quest.progress / quest.target) * 100);
      var timeLeft = '';
      if (quest.type === 'daily') {
        var hoursLeft = Math.ceil((quest.lastReset + CONFIG.DAILY_QUEST_RESET - Date.now()) / (1000 * 60 * 60));
        timeLeft = '<span class="quest-timer">â±ï¸ ' + hoursLeft + 'h left</span>';
      } else if (quest.type === 'weekly') {
        var daysLeft = Math.ceil((quest.lastReset + CONFIG.WEEKLY_QUEST_RESET - Date.now()) / (1000 * 60 * 60 * 24));
        timeLeft = '<span class="quest-timer">â±ï¸ ' + daysLeft + 'd left</span>';
      }
      var rewardHTML = '<div class="quest-reward">';
      if (quest.reward.xp) rewardHTML += '<span>+' + quest.reward.xp + ' XP</span>';
      if (quest.reward.badge) rewardHTML += '<span>ğŸ… ' + quest.reward.badge + '</span>';
      rewardHTML += '</div>';
      div.innerHTML = `
        <div class="quest-title">${quest.title}</div>
        <div class="quest-desc">${quest.desc} ${timeLeft}</div>
        <div class="quest-progress">
          <div class="quest-progress-fill" style="width:${progressPercent}%"></div>
        </div>
        <div style="font-size:11px; color:var(--muted); margin-bottom:8px">
          ${quest.progress} / ${quest.target}
        </div>
        ${rewardHTML}
      `;
      content.appendChild(div);
    });
    var activeQuests = QuestSystem.quests.filter(function(q) {
      return !q.completed && q.type === 'daily';
    }).length;
    var questCount = document.getElementById('questCount');
    if (questCount) questCount.textContent = activeQuests;
  },
  openPanel: function() {
    var panel = document.getElementById('questPanel');
    if (panel) {
      panel.classList.add('open');
      QuestSystem.render();
    }
  },
  closePanel: function() {
    var panel = document.getElementById('questPanel');
    if (panel) panel.classList.remove('open');
  }
};

var AchievementSystem = {
  achievements: [],
  templates: [
    {id:'first_visit', icon:'ğŸš€', name:'First Steps', desc:'Visit your first directory', condition:function(state){return state.visits >= 1}},
    {id:'explorer', icon:'ğŸ—ºï¸', name:'Explorer', desc:'Visit 10 directories', condition:function(state){return state.visits >= 10}},
    {id:'voyager', icon:'ğŸŒŒ', name:'Voyager', desc:'Visit 50 directories', condition:function(state){return state.visits >= 50}},
    {id:'legend', icon:'â­', name:'Legend', desc:'Visit 100 directories', condition:function(state){return state.visits >= 100}, rarity:'legendary'},
    {id:'level_5', icon:'ğŸ–ï¸', name:'Novice', desc:'Reach level 5', condition:function(state){return state.lvl >= 5}},
    {id:'level_10', icon:'ğŸ…', name:'Adept', desc:'Reach level 10', condition:function(state){return state.lvl >= 10}},
    {id:'level_25', icon:'ğŸ‘‘', name:'Master', desc:'Reach level 25', condition:function(state){return state.lvl >= 25}},
    {id:'level_50', icon:'ğŸ’', name:'Grand Master', desc:'Reach level 50', condition:function(state){return state.lvl >= 50}, rarity:'legendary'},
    {id:'ai_first', icon:'ğŸ¤–', name:'AI Collaborator', desc:'Enhance first directory with AI', condition:function(state){return state.enhances >= 1}},
    {id:'ai_master', icon:'âœ¨', name:'AI Master', desc:'Enhance 50 directories', condition:function(state){return state.enhances >= 50}, rarity:'legendary'},
    {id:'streak_7', icon:'ğŸ”¥', name:'Week Warrior', desc:'7-day streak', condition:function(state){return state.streak >= 7}},
    {id:'streak_30', icon:'ğŸ’ª', name:'Month Master', desc:'30-day streak', condition:function(state){return state.streak >= 30}, rarity:'legendary'},
    {id:'collector', icon:'â­', name:'Collector', desc:'Favorite 20 items', condition:function(state){return Object.keys(state.favs).length >= 20}}
  ],
  init: function() {
    return DB.getAll(CONFIG.STORE_NAMES.ACHIEVEMENTS).then(function(saved) {
      if (saved.length === 0) {
        AchievementSystem.achievements = AchievementSystem.templates.map(function(t) {
          return {
            id: t.id,
            icon: t.icon,
            name: t.name,
            desc: t.desc,
            condition: t.condition,
            rarity: t.rarity || 'common',
            unlocked: false,
            unlockedAt: null
          };
        });
        return AchievementSystem.saveAll();
      } else {
        AchievementSystem.achievements = AchievementSystem.templates.map(function(t) {
          var savedAch = saved.find(function(a) { return a.id === t.id; });
          return {
            id: t.id,
            icon: t.icon,
            name: t.name,
            desc: t.desc,
            condition: t.condition,
            rarity: t.rarity || 'common',
            unlocked: savedAch ? savedAch.unlocked : false,
            unlockedAt: savedAch ? savedAch.unlockedAt : null
          };
        });
      }
    });
  },
  saveAll: function() {
    var promises = AchievementSystem.achievements.map(function(ach) {
      var toSave = Object.assign({}, ach);
      delete toSave.condition;
      return DB.set(CONFIG.STORE_NAMES.ACHIEVEMENTS, toSave);
    });
    return Promise.all(promises);
  },
  check: function(state) {
    var newUnlocks = [];
    AchievementSystem.achievements.forEach(function(ach) {
      if (!ach.unlocked && ach.condition(state)) {
        ach.unlocked = true;
        ach.unlockedAt = Date.now();
        newUnlocks.push(ach);
      }
    });
    if (newUnlocks.length > 0) {
      AchievementSystem.saveAll().then(function() {
        newUnlocks.forEach(function(ach) {
          NotificationSystem.show({
            type: 'achievement',
            title: 'ğŸ† Achievement Unlocked!',
            body: ach.icon + ' ' + ach.name,
            rewards: {desc: ach.desc}
          });
          var bonusXP = ach.rarity === 'legendary' ? 500 : 100;
          State.addXP(bonusXP);
        });
      });
    }
  }
};

var LeaderboardSystem = {
  getTitles: function() {
    var titles = [
      {level:1, title:'Novice Explorer'},
      {level:5, title:'Adept Seeker'},
      {level:10, title:'Expert Wayfinder'},
      {level:15, title:'Master Navigator'},
      {level:20, title:'Grand Sentinel'},
      {level:30, title:'Legendary Guardian'},
      {level:50, title:'Eternal Protector'}
    ];
    var currentTitle = 'Novice Explorer';
    titles.forEach(function(t) {
      if (State.lvl >= t.level) currentTitle = t.title;
    });
    return currentTitle;
  },
  render: function() {
    var content = document.getElementById('leaderboardContent');
    if (!content) return;
    var stats = {
      level: State.lvl,
      xp: State.xp,
      visits: State.visits || 0,
      enhances: State.enhances || 0,
      favorites: Object.keys(State.favs).length,
      streak: State.streak || 0,
      achievements: AchievementSystem.achievements.filter(function(a){return a.unlocked}).length,
      totalAchievements: AchievementSystem.achievements.length
    };
    var title = LeaderboardSystem.getTitles();
    content.innerHTML = `
      <div class="rank-card">
        <div class="rank-title">${title}</div>
        <div class="rank-stats">
          <div class="rank-stat">
            <div class="rank-stat-value">${stats.level}</div>
            <div class="rank-stat-label">Level</div>
          </div>
          <div class="rank-stat">
            <div class="rank-stat-value">${stats.visits}</div>
            <div class="rank-stat-label">Visits</div>
          </div>
          <div class="rank-stat">
            <div class="rank-stat-value">${stats.enhances}</div>
            <div class="rank-stat-label">Enhanced</div>
          </div>
          <div class="rank-stat">
            <div class="rank-stat-value">${stats.streak}</div>
            <div class="rank-stat-label">Streak</div>
          </div>
        </div>
      </div>
      <div class="title-showcase">
        <h3>Your Title</h3>
        <div class="player-title">${title}</div>
      </div>
      <h3 style="margin:20px 0 12px; color:var(--accent)">ğŸ† Achievements (${stats.achievements}/${stats.totalAchievements})</h3>
      <div class="achievement-grid" id="achievementGrid"></div>
    `;
    var grid = document.getElementById('achievementGrid');
    AchievementSystem.achievements.forEach(function(ach) {
      var card = document.createElement('div');
      card.className = 'achievement-card';
      if (ach.unlocked) card.classList.add('unlocked');
      if (ach.rarity === 'legendary') card.classList.add('legendary');
      if (!ach.unlocked) card.classList.add('achievement-locked');
      card.innerHTML = `
        <div class="achievement-icon">${ach.icon}</div>
        <div class="achievement-name">${ach.name}</div>
      `;
      card.title = ach.desc;
      grid.appendChild(card);
    });
  },
  open: function() {
    LeaderboardSystem.render();
    var panel = document.getElementById('leaderboardPanel');
    if (panel) panel.classList.add('open');
  },
  close: function() {
    var panel = document.getElementById('leaderboardPanel');
    if (panel) panel.classList.remove('open');
  }
};

var NotificationSystem = {
  show: function(notification) {
    var container = document.getElementById('notificationContainer');
    if (!container) return;
    var div = document.createElement('div');
    div.className = 'notification ' + notification.type;
    var rewardsHTML = '';
    if (notification.rewards) {
      rewardsHTML = '<div class="notification-rewards">';
      if (notification.rewards.xp) rewardsHTML += '<span>+' + notification.rewards.xp + ' XP</span>';
      if (notification.rewards.badge) rewardsHTML += '<span>ğŸ… ' + notification.rewards.badge + '</span>';
      if (notification.rewards.desc) rewardsHTML += '<span>' + notification.rewards.desc + '</span>';
      rewardsHTML += '</div>';
    }
    div.innerHTML = `
      <div class="notification-title">${notification.title}</div>
      <div class="notification-body">${notification.body}</div>
      ${rewardsHTML}
    `;
    container.appendChild(div);
    setTimeout(function() {
      div.style.animation = 'slideInRight 0.4s reverse';
      setTimeout(function() {
        if (div.parentNode) div.parentNode.removeChild(div);
      }, 400);
    }, 5000);
  }
};

var State = {
  xp: 0,
  lvl: 1,
  favs: {},
  visits: 0,
  enhances: 0,
  streak: 0,
  lastVisit: null,
  load: function() {
    return DB.get(CONFIG.STORE_NAMES.USER_DATA, 'state').then(function(saved) {
      if (saved) {
        State.xp = saved.xp || 0;
        State.lvl = saved.lvl || 1;
        State.favs = saved.favs || {};
        State.visits = saved.visits || 0;
        State.enhances = saved.enhances || 0;
        State.streak = saved.streak || 0;
        State.lastVisit = saved.lastVisit || null;
      }
      State.updateStreak();
      return Promise.all([
        QuestSystem.init(),
        AchievementSystem.init()
      ]);
    });
  },
  save: function() {
    return DB.set(CONFIG.STORE_NAMES.USER_DATA, {
      key: 'state',
      xp: State.xp,
      lvl: State.lvl,
      favs: State.favs,
      visits: State.visits,
      enhances: State.enhances,
      streak: State.streak,
      lastVisit: State.lastVisit
    });
  },
  updateStreak: function() {
    var now = Date.now();
    if (!State.lastVisit) {
      State.streak = 1;
      State.lastVisit = now;
      State.save();
      return;
    }
    var timeSinceLastVisit = now - State.lastVisit;
    if (timeSinceLastVisit <= CONFIG.STREAK_GRACE_PERIOD) {
      if (timeSinceLastVisit >= 20 * 60 * 60 * 1000) {
        State.streak++;
        State.lastVisit = now;
        var bonusXP = Math.floor(State.streak * 5);
        State.addXP(bonusXP, true);
        Toast.show('ğŸ”¥ ' + State.streak + ' day streak! +' + bonusXP + ' bonus XP', 'success');
        AchievementSystem.check(State);
        State.save();
      }
    } else {
      if (State.streak >= 3) {
        Toast.show('ğŸ’” Your ' + State.streak + ' day streak was broken', 'info');
      }
      State.streak = 1;
      State.lastVisit = now;
      State.save();
    }
  },
  addXP: function(amount, skipNotification) {
    State.xp += amount;
    var xpNeeded = State.getXPNeeded();
    while (State.xp >= xpNeeded && State.lvl < CONFIG.MAX_LEVEL) {
      State.xp -= xpNeeded;
      State.lvl++;
      if (!skipNotification) {
        NotificationSystem.show({
          type: 'level-up',
          title: 'ğŸ‰ Level Up!',
          body: 'You reached level ' + State.lvl,
          rewards: {desc: 'New rewards unlocked!'}
        });
      }
      xpNeeded = State.getXPNeeded();
      AchievementSystem.check(State);
      ThemeManager.checkUnlocks();
    }
    State.save();
    State.renderHUD();
  },
  getXPNeeded: function() {
    return State.lvl * CONFIG.XP_CURVE;
  },
  renderHUD: function() {
    var xpText = document.getElementById('xpText');
    var xpfill = document.getElementById('xpfill');
    var lvlText = document.getElementById('lvlText');
    var badge = document.getElementById('badge');
    var streakText = document.getElementById('streakText');
    var xpNeeded = State.getXPNeeded();
    var xpPercent = (State.xp / xpNeeded) * 100;
    if (xpText) xpText.textContent = 'XP: ' + State.xp + ' / ' + xpNeeded;
    if (xpfill) xpfill.style.width = xpPercent + '%';
    if (lvlText) lvlText.textContent = State.lvl;
    if (streakText) streakText.textContent = State.streak + ' Day Streak';
    if (badge) {
      var title = LeaderboardSystem.getTitles();
      badge.textContent = title;
    }
  },
  incrementVisit: function() {
    State.visits++;
    State.save();
    QuestSystem.updateProgress('daily_explore');
    QuestSystem.updateProgress('weekly_explorer');
    QuestSystem.updateProgress('story_first');
    QuestSystem.updateProgress('story_hundred');
    AchievementSystem.check(State);
  },
  incrementEnhance: function() {
    State.enhances++;
    State.save();
    QuestSystem.updateProgress('daily_enhance');
    QuestSystem.updateProgress('weekly_ai');
    QuestSystem.updateProgress('story_ai_master');
    AchievementSystem.check(State);
  },
  toggleFavorite: function(path) {
    if (State.favs[path]) {
      delete State.favs[path];
    } else {
      State.favs[path] = true;
      QuestSystem.updateProgress('daily_favorite');
    }
    State.save();
    AchievementSystem.check(State);
  }
};

var ThemeManager = {
  current: 'space',
  init: function() {
    var saved = localStorage.getItem('theme');
    if (saved) {
      ThemeManager.setTheme(saved, true);
    }
    ThemeManager.checkUnlocks();
    var btns = document.querySelectorAll('.theme-btn');
    btns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var theme = btn.getAttribute('data-theme');
        if (ThemeManager.isUnlocked(theme)) {
          ThemeManager.setTheme(theme);
        } else {
          var level = CONFIG.THEME_UNLOCK_LEVELS[theme];
          Toast.show('ğŸ”’ Theme locked. Reach level ' + level + ' to unlock!', 'info');
        }
      });
    });
  },
  isUnlocked: function(theme) {
    var requiredLevel = CONFIG.THEME_UNLOCK_LEVELS[theme] || 1;
    return State.lvl >= requiredLevel;
  },
  checkUnlocks: function() {
    var btns = document.querySelectorAll('.theme-btn');
    btns.forEach(function(btn) {
      var theme = btn.getAttribute('data-theme');
      if (!ThemeManager.isUnlocked(theme)) {
        btn.classList.add('locked');
      } else {
        btn.classList.remove('locked');
      }
    });
  },
  setTheme: function(theme, skipSave) {
    if (!ThemeManager.isUnlocked(theme)) return;
    document.documentElement.setAttribute('data-theme', theme);
    ThemeManager.current = theme;
    if (!skipSave) {
      localStorage.setItem('theme', theme);
    }
    var btns = document.querySelectorAll('.theme-btn');
    btns.forEach(function(btn) {
      if (btn.getAttribute('data-theme') === theme) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  }
};

var Toast = {
  show: function(msg, type, duration) {
    var toast = document.getElementById('toast');
    var toastMsg = document.getElementById('toastMsg');
    if (!toast || !toastMsg) return;
    toastMsg.textContent = msg;
    toast.className = 'toast show ' + (type || 'info');
    setTimeout(function() {
      toast.classList.remove('show');
    }, duration || 3000);
  }
};

var UI = {
  renderAll: function(filterTag, searchTerm, onlyFavs, onlyEnhanced) {
    var grid = document.getElementById('allGrid');
    if (!grid) return Promise.resolve();
    return DB.getAll(CONFIG.STORE_NAMES.DIRECTORIES).then(function(dirs) {
      if (dirs.length === 0) {
        var promises = CONFIG.SAMPLE_DIRECTORIES.map(function(dir) {
          return DB.set(CONFIG.STORE_NAMES.DIRECTORIES, dir);
        });
        return Promise.all(promises).then(function() {
          return UI.renderAll(filterTag, searchTerm, onlyFavs, onlyEnhanced);
        });
      }
      var filtered = dirs.filter(function(dir) {
        if (filterTag && !dir.tags.some(function(t){return t.includes(filterTag)})) return false;
        if (searchTerm && !dir.path.toLowerCase().includes(searchTerm.toLowerCase())) return false;
        if (onlyFavs && !State.favs[dir.path]) return false;
        if (onlyEnhanced && !dir.enhanced) return false;
        return true;
      });
      grid.innerHTML = '';
      if (filtered.length === 0) {
        grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:var(--muted); padding:40px">No directories found</p>';
        return;
      }
      filtered.forEach(function(dir) {
        var card = UI.createCardElement(dir);
        grid.appendChild(card);
      });
    });
  },
  createCardElement: function(dir) {
    var card = document.createElement('div');
    card.className = 'card';
    var tagsHTML = dir.tags.map(function(tag) {
      return '<span class="card-tag">' + tag + '</span>';
    }).join('');
    var isFav = State.favs[dir.path];
    card.innerHTML = `
      <div class="card-front">
        <div class="card-actions">
          <button class="card-btn fav ${isFav?'on':''}" data-path="${dir.path}" title="Favorite">
            ${isFav?'â˜…':'â˜†'}
          </button>
          <button class="card-btn" title="Flip card">ğŸ”„</button>
        </div>
        <div class="card-title">${dir.path}</div>
        <div class="card-meta">${tagsHTML}</div>
        <div class="card-desc">${dir.desc || 'No description available'}</div>
        <a href="#" class="card-link" data-path="${dir.path}">Explore â†’</a>
      </div>
      <div class="card-back">
        <h3 style="color:var(--accent); margin-bottom:12px">ğŸ“Š Stats</h3>
        <p style="font-size:13px; color:var(--muted); margin-bottom:8px">
          <strong>Visits:</strong> ${dir.visits || 0}<br>
          <strong>Enhanced:</strong> ${dir.enhanced ? 'Yes' : 'No'}<br>
          <strong>Tags:</strong> ${dir.tags.join(', ')}
        </p>
      </div>
    `;
    var favBtn = card.querySelector('.card-btn.fav');
    if (favBtn) {
      favBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        State.toggleFavorite(dir.path);
        favBtn.classList.toggle('on');
        favBtn.textContent = State.favs[dir.path] ? 'â˜…' : 'â˜†';
      });
    }
    var flipBtn = card.querySelectorAll('.card-btn')[1];
    if (flipBtn) {
      flipBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        card.classList.toggle('flipped');
      });
    }
    card.addEventListener('dblclick', function() {
      card.classList.toggle('flipped');
    });
    var link = card.querySelector('.card-link');
    if (link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        State.incrementVisit();
        State.addXP(10);
        Toast.show('ğŸ“– Explored ' + dir.path + ' (+10 XP)', 'success');
        dir.visits = (dir.visits || 0) + 1;
        DB.set(CONFIG.STORE_NAMES.DIRECTORIES, dir);
      });
    }
    return card;
  },
  renderFeatured: function() {
    var grid = document.getElementById('featuredGrid');
    if (!grid) return Promise.resolve();
    return DB.getAll(CONFIG.STORE_NAMES.DIRECTORIES).then(function(dirs) {
      var featured = dirs.filter(function(d) {
        return d.tags.some(function(t){return t.includes('sentinel') || t.includes('peace')});
      }).slice(0, 3);
      grid.innerHTML = '';
      featured.forEach(function(dir) {
        var card = UI.createCardElement(dir);
        grid.appendChild(card);
      });
    });
  }
};

var ExportManager = {
  exportHTML: function() {
    var html = document.documentElement.outerHTML;
    var blob = new Blob([html], {type: 'text/html'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'galactic-directory-' + Date.now() + '.html';
    a.click();
    URL.revokeObjectURL(url);
    Toast.show('âœ… HTML exported successfully', 'success');
  },
  exportJSON: function() {
    Promise.all([
      DB.getAll(CONFIG.STORE_NAMES.DIRECTORIES),
      DB.get(CONFIG.STORE_NAMES.USER_DATA, 'state')
    ]).then(function(results) {
      var data = {
        directories: results[0],
        state: results[1],
        exportedAt: new Date().toISOString()
      };
      var json = JSON.stringify(data, null, 2);
      var blob = new Blob([json], {type: 'application/json'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'galactic-directory-data-' + Date.now() + '.json';
      a.click();
      URL.revokeObjectURL(url);
      Toast.show('âœ… JSON exported successfully', 'success');
    });
  },
  exportPDF: function() {
    Toast.show('ğŸ“„ Use your browser\'s Print function (Ctrl+P) to save as PDF', 'info', 5000);
    setTimeout(function() {
      window.print();
    }, 1000);
  }
};

var Dashboard = {
  open: function() {
    var modal = document.getElementById('dashModal');
    var content = document.getElementById('dashContent');
    if (!modal || !content) return;
    var stats = {
      level: State.lvl,
      xp: State.xp,
      xpNeeded: State.getXPNeeded(),
      visits: State.visits || 0,
      enhances: State.enhances || 0,
      favorites: Object.keys(State.favs).length,
      streak: State.streak || 0,
      achievements: AchievementSystem.achievements.filter(function(a){return a.unlocked}).length,
      totalAchievements: AchievementSystem.achievements.length,
      completedQuests: QuestSystem.quests.filter(function(q){return q.completed}).length,
      totalQuests: QuestSystem.quests.length
    };
    content.innerHTML = `
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-value">${stats.level}</div>
          <div class="stat-label">Current Level</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.visits}</div>
          <div class="stat-label">Total Visits</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.enhances}</div>
          <div class="stat-label">AI Enhanced</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.streak}ğŸ”¥</div>
          <div class="stat-label">Day Streak</div>
        </div>
      </div>
      <h3 style="margin:24px 0 12px; color:var(--accent)">ğŸ“Š Progress Overview</h3>
      <div style="background:#0a152a; border:1px solid #203353; border-radius:12px; padding:20px">
        <div style="margin-bottom:16px">
          <div style="display:flex; justify-content:space-between; margin-bottom:8px">
            <span>XP Progress</span>
            <span>${stats.xp} / ${stats.xpNeeded}</span>
          </div>
          <div class="xpbar" style="width:100%; height:12px">
            <div class="xpfill" style="width:${(stats.xp/stats.xpNeeded)*100}%"></div>
          </div>
        </div>
        <div style="margin-bottom:16px">
          <div style="display:flex; justify-content:space-between; margin-bottom:8px">
            <span>Achievements</span>
            <span>${stats.achievements} / ${stats.totalAchievements}</span>
          </div>
          <div class="xpbar" style="width:100%; height:12px">
            <div class="xpfill" style="width:${(stats.achievements/stats.totalAchievements)*100}%"></div>
          </div>
        </div>
        <div>
          <div style="display:flex; justify-content:space-between; margin-bottom:8px">
            <span>Quest Completion</span>
            <span>${stats.completedQuests} / ${stats.totalQuests}</span>
          </div>
          <div class="xpbar" style="width:100%; height:12px">
            <div class="xpfill" style="width:${(stats.completedQuests/stats.totalQuests)*100}%"></div>
          </div>
        </div>
      </div>
      <h3 style="margin:24px 0 12px; color:var(--accent)">ğŸ¯ Quick Stats</h3>
      <div style="background:#0a152a; border:1px solid #203353; border-radius:12px; padding:20px">
        <p style="margin-bottom:8px">â­ Favorite Directories: <strong>${stats.favorites}</strong></p>
        <p style="margin-bottom:8px">ğŸ”¥ Current Streak: <strong>${stats.streak} days</strong></p>
        <p style="margin-bottom:8px">ğŸ† Title: <strong>${LeaderboardSystem.getTitles()}</strong></p>
        <p>ğŸ–ï¸ Next Level: <strong>${stats.xpNeeded - stats.xp} XP needed</strong></p>
      </div>
    `;
    modal.classList.add('open');
  },
  close: function() {
    var modal = document.getElementById('dashModal');
    if (modal) modal.classList.remove('open');
  }
};

var Parallax = {
  stars: [],
  particles: [],
  init: function() {
    var starsCanvas = document.getElementById('stars');
    var particlesCanvas = document.getElementById('particles');
    if (!starsCanvas || !particlesCanvas) return;
    function resize(canvas) {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resize(starsCanvas);
    resize(particlesCanvas);
    window.addEventListener('resize', function() {
      resize(starsCanvas);
      resize(particlesCanvas);
    });
    for (var i = 0; i < 200; i++) {
      Parallax.stars.push({
        x: Math.random() * starsCanvas.width,
        y: Math.random() * starsCanvas.height,
        size: Math.random() * 2,
        speed: Math.random() * 0.5
      });
    }
    for (var i = 0; i < 50; i++) {
      Parallax.particles.push({
        x: Math.random() * particlesCanvas.width,
        y: Math.random() * particlesCanvas.height,
        vx: (Math.random() - 0.5) * 2,
        vy: (Math.random() - 0.5) * 2,
        size: Math.random() * 3
      });
    }
    Parallax.animate();
  },
  animate: function() {
    var starsCanvas = document.getElementById('stars');
    var particlesCanvas = document.getElementById('particles');
    if (!starsCanvas || !particlesCanvas) return;
    var starsCtx = starsCanvas.getContext('2d');
    var particlesCtx = particlesCanvas.getContext('2d');
    starsCtx.clearRect(0, 0, starsCanvas.width, starsCanvas.height);
    particlesCtx.clearRect(0, 0, particlesCanvas.width, particlesCanvas.height);
    starsCtx.fillStyle = 'rgba(255,255,255,0.8)';
    Parallax.stars.forEach(function(star) {
      starsCtx.beginPath();
      starsCtx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
      starsCtx.fill();
      star.y += star.speed;
      if (star.y > starsCanvas.height) {
        star.y = 0;
        star.x = Math.random() * starsCanvas.width;
      }
    });
    particlesCtx.fillStyle = 'rgba(101,179,255,0.6)';
    Parallax.particles.forEach(function(p) {
      particlesCtx.beginPath();
      particlesCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      particlesCtx.fill();
      p.x += p.vx;
      p.y += p.vy;
      if (p.x < 0 || p.x > particlesCanvas.width) p.vx *= -1;
      if (p.y < 0 || p.y > particlesCanvas.height) p.vy *= -1;
    });
    requestAnimationFrame(Parallax.animate);
  }
};

function initControls() {
  var search = document.getElementById('search');
  var filter = document.getElementById('filter');
  var favBtn = document.getElementById('favoritesBtn');
  var enhancedBtn = document.getElementById('enhancedBtn');
  function updateUI() {
    var filterTag = filter ? filter.value : '';
    var searchTerm = search ? search.value : '';
    var onlyFavs = favBtn ? favBtn.classList.contains('on') : false;
    var onlyEnhanced = enhancedBtn ? enhancedBtn.classList.contains('on') : false;
    UI.renderAll(filterTag, searchTerm, onlyFavs, onlyEnhanced);
  }
  if (search) search.addEventListener('input', updateUI);
  if (filter) filter.addEventListener('change', updateUI);
  if (favBtn) {
    favBtn.addEventListener('click', function() {
      favBtn.classList.toggle('on');
      favBtn.textContent = favBtn.classList.contains('on') ? 'â˜… Favorites (On)' : 'â˜… Favorites';
      updateUI();
    });
  }
  if (enhancedBtn) {
    enhancedBtn.addEventListener('click', function() {
      enhancedBtn.classList.toggle('on');
      enhancedBtn.textContent = enhancedBtn.classList.contains('on') ? 'âœ¨ Enhanced (On)' : 'âœ¨ Enhanced Only';
      updateUI();
    });
  }
  var exportHTML = document.getElementById('exportHTML');
  var exportJSON = document.getElementById('exportJSON');
  var exportPDF = document.getElementById('exportPDF');
  if (exportHTML) exportHTML.addEventListener('click', ExportManager.exportHTML);
  if (exportJSON) exportJSON.addEventListener('click', ExportManager.exportJSON);
  if (exportPDF) exportPDF.addEventListener('click', ExportManager.exportPDF);
  var resetBtn = document.getElementById('resetProg');
  if (resetBtn) {
    resetBtn.addEventListener('click', function() {
      if (!confirm('âš ï¸ Reset ALL progress? This cannot be undone.')) return;
      Promise.all([
        DB.clear(CONFIG.STORE_NAMES.DIRECTORIES),
        DB.clear(CONFIG.STORE_NAMES.USER_DATA),
        DB.clear(CONFIG.STORE_NAMES.QUESTS),
        DB.clear(CONFIG.STORE_NAMES.ACHIEVEMENTS)
      ]).then(function() {
        localStorage.clear();
        location.reload();
      });
    });
  }
  var questBtn = document.getElementById('questBtn');
  var questClose = document.getElementById('questClose');
  if (questBtn) questBtn.addEventListener('click', QuestSystem.openPanel);
  if (questClose) questClose.addEventListener('click', QuestSystem.closePanel);
  var questTabs = document.querySelectorAll('.quest-tab');
  questTabs.forEach(function(tab) {
    tab.addEventListener('click', function() {
      questTabs.forEach(function(t) { t.classList.remove('active'); });
      tab.classList.add('active');
      QuestSystem.activeTab = tab.getAttribute('data-tab');
      QuestSystem.render();
    });
  });
  var leaderboardBtn = document.getElementById('leaderboardBtn');
  var leaderboardClose = document.getElementById('leaderboardClose');
  if (leaderboardBtn) leaderboardBtn.addEventListener('click', LeaderboardSystem.open);
  if (leaderboardClose) leaderboardClose.addEventListener('click', LeaderboardSystem.close);
  var dashBtn = document.getElementById('dashBtn');
  var dashClose = document.getElementById('dashClose');
  var dashModal = document.getElementById('dashModal');
  if (dashBtn) dashBtn.addEventListener('click', Dashboard.open);
  if (dashClose) dashClose.addEventListener('click', Dashboard.close);
  if (dashModal) {
    dashModal.addEventListener('click', function(e) {
      if (e.target === dashModal) Dashboard.close();
    });
  }
  var showAbout = document.getElementById('showAbout');
  if (showAbout) {
    showAbout.addEventListener('click', function(e) {
      e.preventDefault();
      alert('ğŸ›¡ï¸ ZERO-HARM COMMITMENT\n\nThis tool is designed for peaceful exploration and learning.\n\nWe do NOT:\nâ€¢ Track individuals\nâ€¢ Sell data\nâ€¢ Use addictive patterns\nâ€¢ Promote harmful content\n\nWe DO:\nâ€¢ Store data locally\nâ€¢ Send anonymous analytics summaries\nâ€¢ Support environmental stewardship\nâ€¢ Respect your privacy\n\nBuilt with vanilla JavaScript for transparency.');
    });
  }
  document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      if (search) search.focus();
    }
    if (e.key === 'Escape') {
      QuestSystem.closePanel();
      LeaderboardSystem.close();
      Dashboard.close();
    }
  });
}

function init() {
  console.log('%cğŸ›¡ï¸ Galactic Directory Enhanced v3.0', 'font-size:20px; color:#65b3ff; font-weight:bold');
  console.log('%câœ¨ Missions Â· Quests Â· Leaderboards Â· Achievements', 'color:#4ee0a1; font-size:14px');
  console.log('%cğŸ® Full Gamification System Active', 'color:#ffd166; font-size:14px');
  DB.open().then(function() {
    return State.load();
  }).then(function() {
    State.renderHUD();
    ThemeManager.init();
    initControls();
    Parallax.init();
    return Promise.all([
      UI.renderFeatured(),
      UI.renderAll()
    ]);
  }).then(function() {
    QuestSystem.render();
    if (State.lvl === 1 && State.xp === 0) {
      setTimeout(function() {
        Toast.show('ğŸš€ Welcome, Explorer! Complete quests to earn XP and unlock rewards!', 'info', 8000);
      }, 1000);
    }
    console.log('%câœ“ Initialization complete', 'color:#4ade80; font-weight:bold');
    console.log('%cğŸ’¡ Press Ctrl+K to search, click ğŸ“œ for quests, ğŸ† for leaderboard', 'color:#ffd166');
  }).catch(function(error) {
    console.error('Fatal initialization error:', error);
    Toast.show('Failed to initialize. Please refresh the page.', 'error');
  });
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>

</body>
</html>
