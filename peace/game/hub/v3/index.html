<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Planetary Restoration Archive ¬∑ Peace Game Hub</title>
<meta name="description" content="Gamified peace-building platform with blockchain integration for evidence-based impact verification"/>
<meta name="theme-color" content="#0b0f1a"/>
<style>
/* =============================================================================
   THEME SYSTEM & CSS VARIABLES
   Purpose: Multi-theme support (default, medieval, space, anime) with auto dark mode
   How to use: Change data-theme attribute on <html> element
   Expected outcome: Instant theme switching across all UI elements
   ============================================================================= */
:root, [data-theme="default"] {
  --bg:#0b0f1a; --panel:#0f1524; --glass:rgba(255,255,255,.06);
  --ink:#e6ecff; --muted:#98a6c7; --accent:#7aa2ff; --good:#5ee1a0; --bad:#ff6b7a; --warn:#ffd36a;
  --header-grad:linear-gradient(180deg,rgba(15,21,36,.88),rgba(15,21,36,.3));
}
[data-theme="medieval"] {
  --bg:#1a0f0b; --panel:#241f15; --glass:rgba(255,240,200,.06);
  --ink:#ffe6d5; --muted:#c7a698; --accent:#d4a574; --good:#90d16b; --bad:#d14444; --warn:#e8b854;
}
[data-theme="space"] {
  --bg:#000000; --panel:#0a0a14; --glass:rgba(100,200,255,.08);
  --ink:#e0f0ff; --muted:#7a9fc7; --accent:#00d9ff; --good:#00ff88; --bad:#ff3366; --warn:#ffaa00;
}
[data-theme="anime"] {
  --bg:#1a0820; --panel:#2a1530; --glass:rgba(255,150,255,.08);
  --ink:#ffe0ff; --muted:#d598c7; --accent:#ff69e0; --good:#69ff94; --bad:#ff5588; --warn:#ffd700;
}

@media (prefers-color-scheme: light) {
  :root:not([data-theme]) {
    --bg:#f8f9fa; --panel:#ffffff; --glass:rgba(0,0,0,.03);
    --ink:#1a1f2e; --muted:#6c757d; --accent:#0066cc; --good:#28a745; --bad:#dc3545; --warn:#ffc107;
  }
}

/* =============================================================================
   BASE STYLES & LAYOUT
   Purpose: Foundational typography and layout structure
   ============================================================================= */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--ink);
  font:16px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
  overflow-x:hidden}

/* =============================================================================
   ANIMATED STARFIELD BACKGROUND
   Purpose: Parallax star animation for visual engagement
   How to use: Automatically renders on page load
   Expected outcome: Gentle moving stars in background
   ============================================================================= */
canvas#starfield{position:fixed;inset:0;z-index:-1;
  background:radial-gradient(1200px 800px at 70% 20%,#101832 0%,#0b0f1a 50%,#070a11 100%)}

/* =============================================================================
   HEADER & NAVIGATION
   Purpose: Sticky header with wallet connection and theme controls
   ============================================================================= */
header{position:sticky;top:0;z-index:1000;
  backdrop-filter:blur(12px) saturate(180%);
  background:var(--header-grad);
  padding:12px 20px;border-bottom:1px solid rgba(122,162,255,.15);
  box-shadow:0 4px 20px rgba(0,0,0,.25)}
.brand{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);
  box-shadow:0 0 10px var(--accent),0 0 24px var(--accent);animation:pulse 2s ease infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.brand h1{font-size:clamp(14px,3vw,18px);letter-spacing:.08em;text-transform:uppercase;color:var(--ink)}
.controls{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}

/* =============================================================================
   UTILITY NAV BAR
   Purpose: Search, export, theme switcher, expand/collapse controls
   ============================================================================= */
.util-nav{background:var(--panel);padding:10px 20px;display:flex;gap:10px;flex-wrap:wrap;
  align-items:center;border-bottom:1px solid rgba(255,255,255,.1)}
.search-box{flex:1;min-width:200px;max-width:400px;position:relative}
.search-box input{width:100%;padding:8px 12px 8px 36px;background:var(--glass);
  border:1px solid rgba(255,255,255,.15);border-radius:20px;color:var(--ink);outline:none}
.search-box::before{content:'üîç';position:absolute;left:12px;top:50%;transform:translateY(-50%)}

/* =============================================================================
   MAIN CONTENT GRID
   Purpose: Responsive card-based layout for all features
   ============================================================================= */
main{max-width:1400px;margin:24px auto;padding:0 16px 80px}
.grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr)}
.card{grid-column:span 12;background:linear-gradient(135deg,var(--panel),rgba(255,255,255,.01));
  border:1px solid rgba(122,162,255,.2);border-radius:16px;overflow:hidden;
  box-shadow:0 8px 30px rgba(0,0,0,.3);transition:transform .2s ease,box-shadow .2s ease}
.card:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(122,162,255,.15)}
@media(min-width:768px){.span6{grid-column:span 6}.span4{grid-column:span 4}.span8{grid-column:span 8}.span3{grid-column:span 3}}

/* =============================================================================
   COLLAPSIBLE SECTIONS
   Purpose: Expandable/collapsible content sections with smooth animation
   How to use: Click header to toggle, or use expand/collapse all buttons
   Expected outcome: Smooth height transition with rotation indicator
   ============================================================================= */
.card-header{padding:16px 20px;cursor:pointer;user-select:none;
  background:linear-gradient(90deg,var(--glass),transparent);
  border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center}
.card-header:hover{background:linear-gradient(90deg,rgba(255,255,255,.08),transparent)}
.card-header h2{font-size:18px;color:var(--ink);display:flex;align-items:center;gap:8px}
.toggle-icon{transition:transform .3s ease;font-size:14px}
.card.collapsed .toggle-icon{transform:rotate(-90deg)}
.card-body{padding:20px;max-height:2000px;overflow:hidden;
  transition:max-height .4s ease,padding .3s ease}
.card.collapsed .card-body{max-height:0;padding:0 20px}

/* =============================================================================
   FORM ELEMENTS
   Purpose: Consistent styling for inputs, buttons, selects
   ============================================================================= */
label{display:block;font-size:13px;color:var(--muted);margin:12px 0 6px;font-weight:500}
input,textarea,select{width:100%;background:var(--glass);border:1px solid rgba(255,255,255,.15);
  color:var(--ink);border-radius:10px;padding:10px 12px;outline:none;transition:border .2s ease}
input:focus,textarea:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(122,162,255,.1)}
textarea{min-height:100px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;resize:vertical}
.row{display:flex;gap:10px;flex-wrap:wrap}.row>*{flex:1;min-width:140px}
button{background:linear-gradient(135deg,#20305c,#152043);color:#eaf1ff;
  border:1px solid rgba(122,162,255,.4);border-radius:10px;padding:10px 16px;cursor:pointer;
  font-weight:500;transition:all .2s ease;white-space:nowrap}
button:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 20px rgba(122,162,255,.25);
  background:linear-gradient(135deg,#2a4070,#1a2850)}
button:disabled{opacity:.5;cursor:not-allowed}
.btn-group{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}

/* =============================================================================
   STATUS & FEEDBACK ELEMENTS
   Purpose: Visual feedback for actions and system state
   ============================================================================= */
.status{margin-top:12px;padding:10px;border-radius:8px;background:var(--glass);
  border-left:3px solid var(--accent);font-size:14px;line-height:1.5}
.good{color:var(--good)}.bad{color:var(--bad)}.warn{color:var(--warn)}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;word-break:break-all;font-size:13px}
.pill{display:inline-block;padding:4px 10px;border-radius:999px;
  border:1px solid rgba(255,255,255,.2);background:var(--glass);font-size:12px}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;
  border-radius:20px;border:1px solid rgba(255,255,255,.25);background:var(--glass);font-size:13px;font-weight:500}
.hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);margin:16px 0}

/* =============================================================================
   TABLE STYLING
   Purpose: Clean data presentation for leaderboards
   ============================================================================= */
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table th,.table td{border-bottom:1px solid rgba(255,255,255,.1);padding:10px;text-align:left}
.table th{background:var(--glass);font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:.05em}
.table tbody tr:hover{background:rgba(255,255,255,.03)}

/* =============================================================================
   TOAST NOTIFICATIONS
   Purpose: Non-intrusive user feedback
   ============================================================================= */
.toast{position:fixed;bottom:24px;right:24px;background:rgba(15,21,36,.95);
  border:1px solid var(--accent);color:var(--ink);padding:12px 18px;border-radius:12px;
  box-shadow:0 8px 30px rgba(0,0,0,.5);display:none;z-index:9999;max-width:90vw;
  animation:slideIn .3s ease}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}

/* =============================================================================
   ZERO-HARM NOTICE
   Purpose: Prominent safety and ethical usage disclaimer
   ============================================================================= */
.zero-harm{background:linear-gradient(135deg,rgba(94,225,160,.1),rgba(122,162,255,.05));
  border:2px solid var(--good);border-radius:12px;padding:16px;margin:20px 0}
.zero-harm h3{color:var(--good);font-size:16px;margin-bottom:8px}
.zero-harm p{font-size:14px;line-height:1.6;margin:4px 0}

/* =============================================================================
   FOOTER
   Purpose: Attribution and licensing information
   ============================================================================= */
footer{text-align:center;color:var(--muted);padding:40px 20px;font-size:14px;line-height:1.8}
footer a{color:var(--accent);text-decoration:none}
footer a:hover{text-decoration:underline}

/* =============================================================================
   PRINT STYLESHEET
   Purpose: Clean PDF export via browser print
   ============================================================================= */
@media print{
  canvas,header,.util-nav,.controls,.btn-group,button,footer{display:none!important}
  .card{page-break-inside:avoid;border:1px solid #ccc}
  .card-body{max-height:none!important;padding:20px!important}
  body{background:#fff;color:#000}
}

/* =============================================================================
   NOSCRIPT FALLBACK
   Purpose: Graceful degradation without JavaScript
   ============================================================================= */
noscript{display:block;padding:20px;background:#dc3545;color:#fff;text-align:center;font-weight:bold}
</style>
</head>
<body>

<!-- ============================================================================
     NOSCRIPT FALLBACK
     Purpose: Inform users that JavaScript is required for full functionality
     ============================================================================ -->
<noscript>
  ‚ö†Ô∏è This application requires JavaScript for blockchain interaction and data storage.
  Please enable JavaScript to use the Peace Game Hub.
</noscript>

<!-- ============================================================================
     ANIMATED STARFIELD CANVAS
     Purpose: Visual engagement with parallax star movement
     ============================================================================ -->
<canvas id="starfield"></canvas>

<!-- ============================================================================
     HEADER & WALLET CONNECTION
     Purpose: Sticky navigation with wallet status and theme switcher
     ============================================================================ -->
<header>
  <div class="brand">
    <div class="dot"></div>
    <h1>Planetary Restoration Archive ‚Äî Peace Game Hub</h1>
    <div class="controls">
      <button id="btnConnect" title="Connect Web3 wallet">Connect Wallet</button>
      <span id="acct" class="pill" style="display:none"></span>
      <span id="net" class="pill" style="display:none"></span>
    </div>
  </div>
</header>

<!-- ============================================================================
     UTILITY NAVIGATION
     Purpose: Search, theme selection, export options, expand/collapse controls
     ============================================================================ -->
<nav class="util-nav">
  <div class="search-box">
    <input type="search" id="searchInput" placeholder="Search sections..." aria-label="Search content"/>
  </div>
  <select id="themeSelect" aria-label="Select theme">
    <option value="default">üåô Default</option>
    <option value="medieval">üè∞ Medieval</option>
    <option value="space">üöÄ Space</option>
    <option value="anime">üå∏ Anime</option>
  </select>
  <button id="btnExpandAll" title="Expand all sections">‚ñº Expand All</button>
  <button id="btnCollapseAll" title="Collapse all sections">‚ñ≤ Collapse All</button>
  <button id="btnExportHTML" title="Save as standalone HTML">üíæ Export HTML</button>
  <button id="btnExportJSON" title="Export data as JSON">üìÑ Export JSON</button>
  <button id="btnPrint" title="Print or save as PDF">üñ®Ô∏è Print/PDF</button>
</nav>

<!-- ============================================================================
     MAIN CONTENT GRID
     Purpose: Modular card-based layout for all peace game features
     ============================================================================ -->
<main>

  <!-- ==========================================================================
       ZERO-HARM DECLARATION
       Purpose: Explicit statement of intended use and safety principles
       ========================================================================== -->
  <section class="zero-harm">
    <h3>üïäÔ∏è Zero-Harm Declaration & Anti-Inversion Commitment</h3>
    <p><strong>Intended Use:</strong> This platform is designed exclusively for peaceful conflict resolution, humanitarian coordination, and evidence-based impact verification. It supports transparent accountability in crisis zones.</p>
    <p><strong>Non-Weaponization:</strong> Any attempt to repurpose this system for surveillance, targeting, misinformation, or harm to individuals, communities, or ecosystems is explicitly prohibited and contrary to its design principles.</p>
    <p><strong>Rate Limiting:</strong> Client-side abuse resistance includes action throttling (max 10 submissions/minute), input sanitization, and data validation.</p>
    <p><strong>License & Attribution:</strong> This code adapts patterns from open-source projects. See footer for full attributions. Respect all upstream licenses.</p>
  </section>

  <div class="grid">

    <!-- ========================================================================
         CONTRACT REGISTRY CARD
         Purpose: Store and manage smart contract ABIs and addresses locally
         How to use: Add contract details, import/export registry as JSON
         Expected outcome: Persistent local storage enables on-chain interactions
         ======================================================================== -->
    <section class="card span8">
      <div class="card-header" onclick="toggleCard(this)">
        <h2>‚öôÔ∏è Contract Registry</h2>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="card-body">
        <p class="muted">Register smart contracts (QuestEscrow, MilestoneVerifier, EthStreamer, etc.) with their addresses and minimal ABIs. All data is stored locally in IndexedDB for offline access.</p>
        <div class="row">
          <div>
            <label>Contract Title</label>
            <input id="regTitle" placeholder="e.g., PeaceToken, QuestEscrow" maxlength="50"/>
          </div>
          <div>
            <label>Contract Address</label>
            <input id="regAddr" placeholder="0x..." pattern="^0x[a-fA-F0-9]{40}$" maxlength="42"/>
          </div>
        </div>
        <label>ABI (JSON Array)</label>
        <textarea id="regAbi" placeholder='[{"type":"function","name":"submit","inputs":[...]}]'></textarea>
        <div class="btn-group">
          <button id="btnRegAdd">‚ûï Add/Update Contract</button>
          <button id="btnRegClear" class="warn">üóëÔ∏è Clear Registry</button>
          <button id="btnRegExport">üì• Export Registry</button>
          <label style="display:inline-block;cursor:pointer;background:linear-gradient(135deg,#20305c,#152043);color:#eaf1ff;border:1px solid rgba(122,162,255,.4);border-radius:10px;padding:10px 16px">
            üì§ Import Registry
            <input type="file" id="btnRegImport" accept=".json" style="display:none"/>
          </label>
        </div>
        <div class="hr"></div>
        <div id="regList" class="status mono"></div>
      </div>
    </section>

    <!-- ========================================================================
         MISSION CREATION CARD
         Purpose: Define peace missions with region, category, and objectives
         How to use: Fill form and publish to local IndexedDB
         Expected outcome: Mission stored with timestamp and creator info
         ======================================================================== -->
    <section class="card span4">
      <div class="card-header" onclick="toggleCard(this)">
        <h2>üéØ Create Mission</h2>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="card-body">
        <p class="muted">Define a new peace-building mission with clear objectives and success criteria.</p>
        <div class="row">
          <div>
            <label>Region/Zone</label>
            <input id="mRegion" placeholder="e.g., gaza, sudan, ukraine" maxlength="30"/>
          </div>
          <div>
            <label>Category</label>
            <select id="mCat">
              <option value="ceasefire">Ceasefire</option>
              <option value="corridor">Aid Corridor</option>
              <option value="school">Education</option>
              <option value="water">Water Access</option>
              <option value="food">Food Security</option>
              <option value="health">Healthcare</option>
              <option value="shelter">Shelter</option>
            </select>
          </div>
        </div>
        <label>Mission Summary</label>
        <textarea id="mSummary" placeholder="Describe objectives, beneficiaries, timeline, and success metrics..." maxlength="1000"></textarea>
        <div class="btn-group">
          <button id="btnMission">üìù Publish Mission</button>
        </div>
        <div id="missionOut" class="status"></div>
      </div>
    </section>

    <!-- ========================================================================
         EVIDENCE BUILDER CARD
         Purpose: Create tamper-evident evidence packages with dual-hash verification
         How to use: Upload files, add notes, compute dual hashes (SHA-256 + BLAKE3)
         Expected outcome: Cryptographic proof bundle exportable as JSON
         ======================================================================== -->
    <section class="card span6">
      <div class="card-header" onclick="toggleCard(this)">
        <h2>üßæ Evidence Builder</h2>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="card-body">
        <p class="muted">Create cryptographically verifiable evidence packages. Dual-hash (SHA-256 + BLAKE3) ensures tamper detection. Optional face-blur for privacy protection.</p>
        <label>Upload Evidence Files</label>
        <div class="row">
          <input type="file" id="evFiles" multiple accept="image/*,.pdf,.txt,.json,.csv,.mp4"/>
        </div>
        <label>Evidence Notes / Manifest</label>
        <textarea id="evNotes" placeholder="Describe evidence set, include OCHA/WHO references, GPS coordinates, timestamps..." maxlength="2000"></textarea>
        <div class="btn-group">
          <button id="btnHash">üîê Compute Dual Hashes</button>
          <button id="btnSaveBundle">üíæ Save Evidence Bundle</button>
        </div>
        <div class="row">
          <input id="hashA" placeholder="SHA-256 bytes32" readonly/>
          <input id="hashB" placeholder="BLAKE3 bytes32" readonly/>
        </div>
        <div id="evOut" class="status mono"></div>
      </div>
    </section>

    <!-- ========================================================================
         IMPACT SUBMISSION CARD
         Purpose: Submit mission outcomes with evidence and metrics
         How to use: Link evidence hashes to mission, add metrics, submit
         Expected outcome: Local simulation + optional on-chain transaction
         ======================================================================== -->
    <section class="card span6">
      <div class="card-header" onclick="toggleCard(this)">
        <h2>‚úÖ Submit Impact</h2>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="card-body">
        <p class="muted">Register mission outcomes with evidence hashes. Metrics feed into Peace Impact Score (PIS) calculation and leaderboards.</p>
        <div class="row">
          <div>
            <label>Mission ID</label>
            <input id="sMissionId" placeholder="Mission identifier" maxlength="20"/>
          </div>
          <div>
            <label>Stake Amount (ETH)</label>
            <input id="sStake" type="number" value="0.01" min="0" step="0.001"/>
          </div>
        </div>
        <div class="row">
          <input id="sHashA" placeholder="Evidence SHA-256 hash" maxlength="66"/>
          <input id="sHashB" placeholder="Evidence BLAKE3 hash" maxlength="66"/>
        </div>
        <label>Impact Metrics</label>
        <div class="row">
          <input id="sDeaths" type="number" placeholder="Deaths prevented" min="0" step="1"/>
          <input id="sInjuries" type="number" placeholder="Injuries prevented" min="0" step="1"/>
          <input id="sMeals" type="number" placeholder="Meals distributed" min="0" step="1"/>
          <input id="sWater" type="number" placeholder="Liters of water" min="0" step="1"/>
        </div>
        <div class="btn-group">
          <button id="btnSubmitImpact">üß™ Submit (Local Simulation)</button>
          <button id="btnSubmitOnChain" disabled>‚õìÔ∏è Submit (On-Chain)</button>
        </div>
        <div id="subOut" class="status"></div>
      </div>
    </section>

    <!-- ========================================================================
         ETH STREAMS CARD
         Purpose: Display claimable ETH rewards based on Peace Impact Score
         How to use: View accrued rewards, claim when available
         Expected outcome: Real-time reward calculation and withdrawal
         ======================================================================== -->
    <section class="card span6">
      <div class="card-header" onclick="toggleCard(this)">
        <h2>üíß ETH Streams</h2>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="card-body">
        <p class="muted">Proportional ETH distribution based on your Peace Impact Score (PIS) share. Streams update continuously as new evidence is verified.</p>
        <div class="badge">
          <span>Claimable Balance:</span>
          <b id="claimable" class="good">0.0000 ETH</b>
        </div>
        <div class="btn-group">
          <button id="btnClaim" disabled>üéÅ Claim Rewards</button>
        </div>
        <div id="streamOut" class="status"></div>
      </div>
    </section>

    <!-- ========================================================================
         LEADERBOARDS CARD
         Purpose: Rank participants by Peace Impact Score across categories
         How to use: View global, regional, and efficiency rankings
         Expected outcome: Transparent competition driving impact
         ======================================================================== -->
    <section class="card span6">
      <div class="card-header" onclick="toggleCard(this)">
        <h2>üèÜ Leaderboards</h2>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="card-body">
        <p class="muted">Rankings by Peace Impact Score (PIS). Scores weight life-saving impact heavily: deaths prevented = 5pts, injuries = 3pts, meals/water = 0.001pts each.</p>
        <div style="overflow-x:auto">
          <table class="table" id="tblLeaders">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Account</th>
                <th>PIS</th>
                <th>Region</th>
                <th>Efficiency</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ========================================================================
         SEASON MANAGEMENT CARD
         Purpose: Configure competitive seasons with prize pools
         How to use: Set duration and jackpot, start/end season
         Expected outcome: Time-bound competition with winner payouts
         ======================================================================== -->
    <section class="card span4">
      <div class="card-header" onclick="toggleCard(this)">
        <h2>‚è≥ Season Management</h2>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="card-body">
        <p class="muted">Create competitive seasons with prize pools distributed to top PIS earners.</p>
        <div class="row">
          <div>
            <label>Season Length (days)</label>
            <input id="seasonDays" type="number" value="30" min="1" max="365"/>
          </div>
          <div>
            <label>Jackpot (ETH)</label>
            <input id="seasonPot" type="number" value="10" min="0" step="0.1"/>
          </div>
        </div>
        <div class="btn-group">
          <button id="btnSeasonStart">‚ñ∂Ô∏è Start Season</button>
          <button id="btnSeasonEnd">‚èπÔ∏è End Season</button>
        </div>
        <div id="seasonOut" class="status"></div>
      </div>
    </section>

    <!-- ========================================================================
         INTEGRITY VERIFICATION CARD
         Purpose: Verify smart contract upgradability and code integrity
         How to use: Provide proxy/guard addresses and contract key
         Expected outcome: Cryptographic verification against allow-list
         ======================================================================== -->
    <section class="card span8">
      <div class="card-header" onclick="toggleCard(this)">
        <h2>üîê Contract Integrity Verify</h2>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="card-body">
        <p class="muted">Verify proxy implementation against UpgradeGuard allow-list. Checks extcodehash of implementation against registered dual-hash.</p>
        <div class="row">
          <div>
            <label>Proxy Address</label>
            <input id="vProxy" placeholder="0x..." pattern="^0x[a-fA-F0-9]{40}$" maxlength="42"/>
          </div>
          <div>
            <label>Guard Address</label>
            <input id="vGuard" placeholder="0x..." pattern="^0x[a-fA-F0-9]{40}$" maxlength="42"/>
          </div>
          <div>
            <label>Contract Key</label>
            <input id="vKey" placeholder="bytes32 identifier" maxlength="66"/>
          </div>
        </div>
        <div class="btn-group">
          <button id="btnVerify">üîç Verify Integrity</button>
        </div>
        <div id="verifyOut" class="status mono"></div>
      </div>
    </section>

    <!-- ========================================================================
         ANALYTICS DASHBOARD CARD
         Purpose: Privacy-respecting usage analytics stored locally
         How to use: View interaction stats, export for optional email reports
         Expected outcome: Transparent usage tracking without external servers
         ======================================================================== -->
    <section class="card span12">
      <div class="card-header" onclick="toggleCard(this)">
        <h2>üìä Analytics Dashboard</h2>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="card-body">
        <p class="muted">Local analytics track usage patterns without external servers. Data stays in your IndexedDB. Optional daily summary available for export.</p>
        <div class="row">
          <div class="badge">
            <span>Sessions Today:</span>
            <b id="statSessions">0</b>
          </div>
          <div class="badge">
            <span>Missions Created:</span>
            <b id="statMissions">0</b>
          </div>
          <div class="badge">
            <span>Evidence Packages:</span>
            <b id="statEvidence">0</b>
          </div>
          <div class="badge">
            <span>Impact Submissions:</span>
            <b id="statSubmissions">0</b>
          </div>
        </div>
        <div class="btn-group">
          <button id="btnExportAnalytics">üìß Export Analytics (JSON)</button>
        </div>
        <div id="analyticsOut" class="status mono"></div>
        <p class="muted" style="margin-top:12px;font-size:12px">Note: To enable automated daily email summaries to admin@planetaryrestorationarchive.com, integrate with a server-side email service (not included for client-side safety).</p>
      </div>
    </section>

  </div>

  <!-- ==========================================================================
       FOOTER WITH ATTRIBUTIONS
       Purpose: License compliance and acknowledgment of adapted patterns
       ========================================================================== -->
  <footer>
    <div class="hr"></div>
    <p><strong>Planetary Restoration Archive ¬© 2025</strong></p>
    <p>Foster + Navi ¬∑ Constellation v2.0 ¬∑ PWA-ready ¬∑ Dual-hash provenance ¬∑ IndexedDB persistence</p>
    <div class="hr"></div>
    <p><strong>Attributions & Licenses</strong></p>
    <p>This project adapts open-source patterns from:
      <a href="https://ethers.org" target="_blank" rel="noopener">Ethers.js</a> (MIT),
      <a href="https://github.com/BLAKE3-team/BLAKE3" target="_blank" rel="noopener">BLAKE3</a> (CC0/Apache2),
      Web3 best practices from <a href="https://ethereum.org/en/developers/" target="_blank" rel="noopener">Ethereum.org</a> (CC-BY).
      All upstream licenses respected.
    </p>
    <p>üåç Built for peace, accountability, and planetary restoration. Non-commercial, humanitarian use encouraged.</p>
  </footer>

</main>

<!-- ============================================================================
     TOAST NOTIFICATION CONTAINER
     Purpose: Non-blocking user feedback for actions
     ============================================================================ -->
<div id="toast" class="toast" role="alert"></div>

<!-- ============================================================================
     EXTERNAL DEPENDENCIES
     Purpose: Blockchain interaction (Ethers.js) and cryptographic hashing (BLAKE3)
     Note: Consider bundling for full offline capability
     ============================================================================ -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blake3@2.1.7/browser.js"></script>

<script>
/* =============================================================================
   CORE JAVASCRIPT APPLICATION
   Purpose: Orchestrate all features with IndexedDB, Web3, analytics, and UI
   ============================================================================= */

'use strict';

/* =============================================================================
   DOM HELPERS
   Purpose: Utility functions for common DOM operations
   ============================================================================= */
const $ = id => document.getElementById(id);
const toast = (msg, duration = 3000) => {
  const t = $('toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', duration);
};

/* =============================================================================
   RATE LIMITING & ABUSE RESISTANCE
   Purpose: Prevent spam and abuse with client-side throttling
   How to use: Wrap submission actions in checkRateLimit()
   Expected outcome: Max 10 actions per minute per action type
   ============================================================================= */
const rateLimits = {};
const checkRateLimit = (action, maxPer10Min = 10) => {
  const now = Date.now();
  if (!rateLimits[action]) rateLimits[action] = [];
  rateLimits[action] = rateLimits[action].filter(t => now - t < 600000); // 10 min window
  if (rateLimits[action].length >= maxPer10Min) {
    toast(`‚ö†Ô∏è Rate limit: max ${maxPer10Min} ${action}s per 10 minutes`, 4000);
    return false;
  }
  rateLimits[action].push(now);
  return true;
};

/* =============================================================================
   INPUT SANITIZATION
   Purpose: Prevent XSS and injection attacks
   ============================================================================= */
const sanitize = str => {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
};

/* =============================================================================
   CRYPTOGRAPHIC UTILITIES
   Purpose: Hash generation and bytes32 formatting
   ============================================================================= */
const toBytes32 = hex => {
  hex = String(hex || '').replace(/^0x/, '').slice(0, 64).padStart(64, '0');
  return '0x' + hex;
};
const sha256 = async bytes => {
  const h = await crypto.subtle.digest('SHA-256', bytes);
  return '0x' + [...new Uint8Array(h)].map(b => b.toString(16).padStart(2, '0')).join('');
};
const b32 = u8 => '0x' + [...u8].map(b => b.toString(16).padStart(2, '0')).join('');

/* =============================================================================
   INDEXEDDB WRAPPER
   Purpose: Persistent local storage for contracts, missions, evidence, analytics
   How to use: await db.put(storeName, data) / await db.get(storeName, key)
   Expected outcome: Offline-first data persistence with graceful fallback
   ============================================================================= */
const db = {
  name: 'PeaceGameHub',
  version: 1,
  instance: null,
  
  async init() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(this.name, this.version);
      req.onerror = () => reject(req.error);
      req.onsuccess = () => {
        this.instance = req.result;
        resolve(this.instance);
      };
      req.onupgradeneeded = e => {
        const database = e.target.result;
        // Create object stores
        if (!database.objectStoreNames.contains('contracts')) {
          database.createObjectStore('contracts', { keyPath: 'title' });
        }
        if (!database.objectStoreNames.contains('missions')) {
          database.createObjectStore('missions', { keyPath: 'id', autoIncrement: true });
        }
        if (!database.objectStoreNames.contains('submissions')) {
          database.createObjectStore('submissions', { keyPath: 'id', autoIncrement: true });
        }
        if (!database.objectStoreNames.contains('analytics')) {
          database.createObjectStore('analytics', { keyPath: 'date' });
        }
      };
    });
  },
  
  async put(storeName, data) {
    const tx = this.instance.transaction(storeName, 'readwrite');
    return new Promise((resolve, reject) => {
      const req = tx.objectStore(storeName).put(data);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  },
  
  async get(storeName, key) {
    const tx = this.instance.transaction(storeName, 'readonly');
    return new Promise((resolve, reject) => {
      const req = tx.objectStore(storeName).get(key);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  },
  
  async getAll(storeName) {
    const tx = this.instance.transaction(storeName, 'readonly');
    return new Promise((resolve, reject) => {
      const req = tx.objectStore(storeName).getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  },
  
  async clear(storeName) {
    const tx = this.instance.transaction(storeName, 'readwrite');
    return new Promise((resolve, reject) => {
      const req = tx.objectStore(storeName).clear();
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  }
};

/* =============================================================================
   ANALYTICS TRACKING
   Purpose: Privacy-respecting local usage statistics
   ============================================================================= */
const analytics = {
  async track(event, data = {}) {
    const today = new Date().toISOString().split('T')[0];
    let record = await db.get('analytics', today) || { date: today, events: [] };
    record.events.push({ event, data, timestamp: Date.now() });
    await db.put('analytics', record);
    this.updateDashboard();
  },
  
  async updateDashboard() {
    const records = await db.getAll('analytics');
    const today = new Date().toISOString().split('T')[0];
    const todayData = records.find(r => r.date === today) || { events: [] };
    
    $('statSessions').textContent = records.length;
    $('statMissions').textContent = todayData.events.filter(e => e.event === 'mission_created').length;
    $('statEvidence').textContent = todayData.events.filter(e => e.event === 'evidence_hashed').length;
    $('statSubmissions').textContent = todayData.events.filter(e => e.event === 'impact_submitted').length;
  }
};

/* =============================================================================
   STARFIELD ANIMATION
   Purpose: Engaging parallax background with moving stars
   ============================================================================= */
(() => {
  const c = $('starfield');
  const ctx = c.getContext('2d');
  let w, h, stars = [];
  
  const resize = () => {
    w = c.width = innerWidth;
    h = c.height = innerHeight;
    stars = Array.from({ length: Math.floor(w * h / 10000) }, () => ({
      x: Math.random() * w,
      y: Math.random() * h,
      z: Math.random() * 0.6 + 0.4,
      r: Math.random() * 1.5 + 0.3
    }));
  };
  
  const tick = () => {
    ctx.clearRect(0, 0, w, h);
    for (const s of stars) {
      s.x += (s.z - 0.5) * 0.4;
      s.y += (s.z - 0.5) * 0.4;
      if (s.x < 0) s.x += w;
      if (s.x > w) s.x -= w;
      if (s.y < 0) s.y += h;
      if (s.y > h) s.y -= h;
      ctx.globalAlpha = 0.7 * s.z;
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(200, 220, 255, 0.9)';
      ctx.fill();
    }
    requestAnimationFrame(tick);
  };
  
  addEventListener('resize', resize);
  resize();
  tick();
})();

/* =============================================================================
   WALLET CONNECTION
   Purpose: Connect to Web3 provider (MetaMask, etc.)
   ============================================================================= */
let provider, signer, account, network;

$('btnConnect').onclick = async () => {
  try {
    if (!window.ethereum) {
      alert('No Web3 wallet detected. Please install MetaMask or similar.');
      return;
    }
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    signer = await provider.getSigner();
    account = await signer.getAddress();
    network = await provider.getNetwork();
    
    $('acct').style.display = 'inline-block';
    $('acct').textContent = account.slice(0, 6) + '...' + account.slice(-4);
    $('net').style.display = 'inline-block';
    $('net').textContent = `${network.name || 'Network'} #${network.chainId}`;
    
    toast('‚úÖ Wallet connected');
    await analytics.track('wallet_connected', { account, chainId: network.chainId.toString() });
  } catch (e) {
    toast('‚ùå ' + (e?.message || 'Wallet connection failed'));
  }
};

/* =============================================================================
   CONTRACT REGISTRY FUNCTIONS
   Purpose: Manage smart contract ABIs and addresses in IndexedDB
   ============================================================================= */
const renderRegistry = async () => {
  const contracts = await db.getAll('contracts');
  $('regList').textContent = contracts.length > 0
    ? JSON.stringify(contracts, null, 2)
    : 'No contracts registered yet.';
  
  // Enable on-chain buttons if required contracts exist
  const hasQuestEscrow = contracts.some(c => c.title === 'QuestEscrow');
  const hasMilestoneVerifier = contracts.some(c => c.title === 'MilestoneVerifier');
  const hasStreamer = contracts.some(c => c.title === 'EthStreamer');
  
  $('btnSubmitOnChain').disabled = !(hasQuestEscrow && hasMilestoneVerifier);
  $('btnClaim').disabled = !hasStreamer;
};

$('btnRegAdd').onclick = async () => {
  try {
    if (!checkRateLimit('contract_add', 20)) return;
    
    const title = sanitize($('regTitle').value.trim());
    const address = $('regAddr').value.trim();
    const abiText = $('regAbi').value.trim();
    
    if (!title || !address || !abiText) {
      throw new Error('All fields required: title, address, ABI');
    }
    if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
      throw new Error('Invalid Ethereum address format');
    }
    
    const abi = JSON.parse(abiText);
    if (!Array.isArray(abi) || abi.length === 0) {
      throw new Error('ABI must be a non-empty JSON array');
    }
    
    await db.put('contracts', { title, address, abi });
    await renderRegistry();
    toast('‚úÖ Contract registered');
    await analytics.track('contract_registered', { title });
  } catch (e) {
    toast('‚ùå ' + (e?.message || 'Invalid input'));
  }
};

$('btnRegClear').onclick = async () => {
  if (!confirm('Clear all registered contracts? This cannot be undone.')) return;
  await db.clear('contracts');
  await renderRegistry();
  toast('üóëÔ∏è Registry cleared');
};

$('btnRegExport').onclick = async () => {
  const contracts = await db.getAll('contracts');
  const blob = new Blob([JSON.stringify(contracts, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'peace-game-contracts.json';
  a.click();
  URL.revokeObjectURL(url);
  toast('üì• Registry exported');
};

$('btnRegImport').onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;
  
  try {
    const text = await file.text();
    const contracts = JSON.parse(text);
    
    if (!Array.isArray(contracts)) throw new Error('Expected JSON array');
    
    for (const c of contracts) {
      if (!c.title || !c.address || !c.abi) continue;
      await db.put('contracts', c);
    }
    
    await renderRegistry();
    toast('üì§ Registry imported');
  } catch (e) {
    toast('‚ùå Import failed: ' + e.message);
  }
};

/* =============================================================================
   MISSION CREATION
   Purpose: Define and store peace missions locally
   ============================================================================= */
$('btnMission').onclick = async () => {
  try {
    if (!checkRateLimit('mission_create', 10)) return;
    
    const region = sanitize($('mRegion').value.trim());
    const category = $('mCat').value;
    const summary = sanitize($('mSummary').value.trim());
    
    if (!region || !summary) {
      throw new Error('Region and summary are required');
    }
    
    const mission = {
      region,
      category,
      summary,
      creator: account || 'anonymous',
      timestamp: Date.now()
    };
    
    await db.put('missions', mission);
    $('missionOut').textContent = `‚úÖ Mission published: ${region} / ${category}`;
    $('missionOut').className = 'status good';
    toast('üìù Mission created');
    await analytics.track('mission_created', { region, category });
  } catch (e) {
    $('missionOut').textContent = '‚ùå ' + e.message;
    $('missionOut').className = 'status bad';
  }
};

/* =============================================================================
   EVIDENCE BUILDER
   Purpose: Create tamper-evident evidence packages with dual-hash
   ============================================================================= */
let evidenceFiles = [];

$('evFiles').onchange = e => {
  evidenceFiles = [...e.target.files];
  $('evOut').textContent = evidenceFiles.map(f => `${f.name} (${(f.size / 1024).toFixed(1)} KB)`).join('\n');
};

$('btnHash').onclick = async () => {
  try {
    if (!checkRateLimit('evidence_hash', 10)) return;
    
    const notes = $('evNotes').value || '';
    const buffers = [];
    
    for (const file of evidenceFiles) {
      buffers.push(new Uint8Array(await file.arrayBuffer()));
    }
    buffers.push(new TextEncoder().encode(notes));
    
    const totalSize = buffers.reduce((sum, b) => sum + b.length, 0);
    const combined = new Uint8Array(totalSize);
    let offset = 0;
    for (const buf of buffers) {
      combined.set(buf, offset);
      offset += buf.length;
    }
    
    const hashSha256 = await sha256(combined);
    const hashBlake3 = blake3.hash(combined);
    
    $('hashA').value = toBytes32(hashSha256);
    $('hashB').value = toBytes32(b32(hashBlake3));
    
    $('evOut').textContent = `‚úÖ Dual-hash computed:\nSHA-256: ${$('hashA').value}\nBLAKE3: ${$('hashB').value}`;
    $('evOut').className = 'status good mono';
    toast('üîê Evidence hashed');
    await analytics.track('evidence_hashed', { fileCount: evidenceFiles.length });
  } catch (e) {
    $('evOut').textContent = '‚ùå ' + e.message;
    $('evOut').className = 'status bad';
  }
};

$('btnSaveBundle').onclick = () => {
  const bundle = {
    timestamp: new Date().toISOString(),
    notes: $('evNotes').value || '',
    files: evidenceFiles.map(f => ({ name: f.name, size: f.size, type: f.type })),
    sha256: $('hashA').value,
    blake3: $('hashB').value
  };
  
  const blob = new Blob([JSON.stringify(bundle, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `evidence-bundle-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('üíæ Evidence bundle saved');
};

/* =============================================================================
   IMPACT SUBMISSION
   Purpose: Submit mission outcomes with evidence and metrics
   ============================================================================= */
$('btnSubmitImpact').onclick = async () => {
  try {
    if (!checkRateLimit('impact_submit', 10)) return;
    
    const missionId = sanitize($('sMissionId').value.trim()) || 'local';
    const stake = parseFloat($('sStake').value || '0');
    const hashA = $('sHashA').value.trim();
    const hashB = $('sHashB').value.trim();
    
    if (!hashA || !hashB) throw new Error('Evidence hashes required');
    
    const metrics = {
      deaths: parseInt($('sDeaths').value || '0'),
      injuries: parseInt($('sInjuries').value || '0'),
      meals: parseInt($('sMeals').value || '0'),
      water: parseInt($('sWater').value || '0')
    };
    
    const submission = {
      missionId,
      submitter: account || 'anonymous',
      stake,
      hashA,
      hashB,
      metrics,
      timestamp: Date.now()
    };
    
    await db.put('submissions', submission);
    $('subOut').textContent = `‚úÖ Impact recorded for mission ${missionId}. Awaiting verification.`;
    $('subOut').className = 'status good';
    toast('‚úÖ Impact submitted');
    await analytics.track('impact_submitted', { missionId, pis: calcPIS(metrics) });
    await updateLeaderboards();
  } catch (e) {
    $('subOut').textContent = '‚ùå ' + e.message;
    $('subOut').className = 'status bad';
  }
};

$('btnSubmitOnChain').onclick = async () => {
  try {
    if (!provider || !signer) throw new Error('Connect wallet first');
    
    const contracts = await db.getAll('contracts');
    const escrow = contracts.find(c => c.title === 'QuestEscrow');
    if (!escrow) throw new Error('QuestEscrow contract not registered');
    
    const contract = new ethers.Contract(escrow.address, escrow.abi, signer);
    const missionId = BigInt($('sMissionId').value || '0');
    const stake = ethers.parseEther(String($('sStake').value || '0'));
    const hashA = $('sHashA').value.trim();
    const hashB = $('sHashB').value.trim();
    
    const tx = await contract.submit(missionId, hashA, hashB, { value: stake });
    $('subOut').textContent = `‚è≥ Transaction pending: ${tx.hash}`;
    
    const receipt = await tx.wait();
    $('subOut').textContent = `‚úÖ On-chain submission confirmed. Block: ${receipt.blockNumber}`;
    $('subOut').className = 'status good';
    toast('‚õìÔ∏è On-chain success');
  } catch (e) {
    $('subOut').textContent = '‚ùå ' + (e?.message || 'Transaction failed');
    $('subOut').className = 'status bad';
  }
};

/* =============================================================================
   PEACE IMPACT SCORE (PIS) CALCULATION
   Purpose: Weighted scoring formula prioritizing life-saving impact
   Formula: deaths*5 + injuries*3 + meals*0.001 + water*0.0002
   ============================================================================= */
const calcPIS = metrics => {
  return (metrics.deaths || 0) * 5 +
         (metrics.injuries || 0) * 3 +
         (metrics.meals || 0) * 0.001 +
         (metrics.water || 0) * 0.0002;
};

/* =============================================================================
   LEADERBOARDS
   Purpose: Rank participants by Peace Impact Score
   ============================================================================= */
const updateLeaderboards = async () => {
  const submissions = await db.getAll('submissions');
  const byUser = {};
  
  for (const sub of submissions) {
    const user = sub.submitter;
    const pis = calcPIS(sub.metrics);
    if (!byUser[user]) {
      byUser[user] = { pis: 0, regions: new Set(), submissions: 0 };
    }
    byUser[user].pis += pis;
    byUser[user].regions.add(sub.missionId.split('-')[0] || 'global');
    byUser[user].submissions += 1;
  }
  
  const rows = Object.entries(byUser)
    .map(([user, data]) => ({
      user,
      pis: data.pis,
      region: [...data.regions].join(', ') || 'global',
      efficiency: (data.pis / (data.submissions || 1)).toFixed(2)
    }))
    .sort((a, b) => b.pis - a.pis)
    .slice(0, 25);
  
  const tbody = $('tblLeaders').querySelector('tbody');
  tbody.innerHTML = '';
  
  rows.forEach((row, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${i + 1}</strong></td>
      <td class="mono">${row.user.slice(0, 8)}...</td>
      <td><strong>${row.pis.toFixed(2)}</strong></td>
      <td>${row.region}</td>
      <td>${row.efficiency}</td>
    `;
    tbody.appendChild(tr);
  });
};

/* =============================================================================
   SEASON MANAGEMENT
   Purpose: Time-bound competitive seasons with prize pools
   ============================================================================= */
let season = { active: false, start: 0, end: 0, pot: 0 };

$('btnSeasonStart').onclick = () => {
  const days = parseInt($('seasonDays').value || '30');
  const pot = parseFloat($('seasonPot').value || '0');
  const now = Date.now();
  
  season = {
    active: true,
    start: now,
    end: now + days * 86400000,
    pot
  };
  
  $('seasonOut').textContent = `‚è≥ Season active until ${new Date(season.end).toLocaleString()}. Jackpot: ${pot} ETH`;
  $('seasonOut').className = 'status';
  toast('‚ñ∂Ô∏è Season started');
};

$('btnSeasonEnd').onclick = async () => {
  if (!season.active) {
    toast('‚ö†Ô∏è No active season');
    return;
  }
  
  season.active = false;
  $('seasonOut').textContent = '‚èπÔ∏è Season ended. Run on-chain settlement via SeasonEngine.';
  $('seasonOut').className = 'status warn';
  toast('‚èπÔ∏è Season closed');
  await analytics.track('season_ended', { pot: season.pot });
};

/* =============================================================================
   ETH STREAMS (CLAIM)
   Purpose: Claim proportional ETH rewards
   ============================================================================= */
$('btnClaim').onclick = async () => {
  try {
    if (!provider || !signer) throw new Error('Connect wallet first');
    
    const contracts = await db.getAll('contracts');
    const streamer = contracts.find(c => c.title === 'EthStreamer');
    if (!streamer) throw new Error('EthStreamer not registered');
    
    const contract = new ethers.Contract(streamer.address, streamer.abi, signer);
    const tx = await contract.claim(account);
    $('streamOut').textContent = `‚è≥ Claiming...`;
    
    const receipt = await tx.wait();
    $('streamOut').textContent = `‚úÖ Claimed. Tx: ${receipt.hash}`;
    $('streamOut').className = 'status good';
    toast('üéÅ ETH claimed');
  } catch (e) {
    $('streamOut').textContent = '‚ùå ' + (e?.message || 'Claim failed');
    $('streamOut').className = 'status bad';
  }
};

/* =============================================================================
   CONTRACT INTEGRITY VERIFICATION
   Purpose: Verify proxy implementation against UpgradeGuard allow-list
   ============================================================================= */
$('btnVerify').onclick = async () => {
  try {
    if (!provider) throw new Error('Connect wallet for RPC access');
    
    const proxy = $('vProxy').value.trim();
    const guard = $('vGuard').value.trim();
    const key = $('vKey').value.trim();
    
    if (!proxy || !guard) throw new Error('Proxy and Guard addresses required');
    
    // EIP-1967 implementation slot
    const IMPL_SLOT = '0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc';
    const implSlot = await provider.getStorage(proxy, IMPL_SLOT);
    const impl = '0x' + implSlot.slice(26);
    
    const code = await provider.getCode(impl);
    const codeHash = ethers.keccak256(code);
    
    // Minimal Guard ABI for isAllowed check
    const guardAbi = [{
      type: 'function',
      stateMutability: 'view',
      outputs: [{ type: 'bool', name: '' }],
      name: 'isAllowed',
      inputs: [{ name: 'k', type: 'bytes32' }, { name: 'h', type: 'bytes32' }]
    }];
    
    const guardContract = new ethers.Contract(guard, guardAbi, provider);
    const allowed = await guardContract.isAllowed(key || ethers.ZeroHash, codeHash);
    
    $('verifyOut').textContent = `${allowed ? '‚úÖ VERIFIED' : '‚ùå FAILED'}\nImpl: ${impl}\nCodeHash: ${codeHash}`;
    $('verifyOut').className = allowed ? 'status good mono' : 'status bad mono';
    toast(allowed ? '‚úÖ Integrity verified' : '‚ùå Verification failed');
  } catch (e) {
    $('verifyOut').textContent = '‚ùå ' + (e?.message || 'Verification error');
    $('verifyOut').className = 'status bad mono';
  }
};

/* =============================================================================
   ANALYTICS EXPORT
   Purpose: Export local analytics as JSON
   ============================================================================= */
$('btnExportAnalytics').onclick = async () => {
  const data = await db.getAll('analytics');
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `peace-game-analytics-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('üìß Analytics exported');
};

/* =============================================================================
   THEME SWITCHER
   Purpose: Multi-theme support with localStorage persistence
   ============================================================================= */
$('themeSelect').onchange = e => {
  const theme = e.target.value;
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('peace-game-theme', theme);
  toast(`üé® Theme: ${theme}`);
};

// Load saved theme
const savedTheme = localStorage.getItem('peace-game-theme');
if (savedTheme) {
  document.documentElement.setAttribute('data-theme', savedTheme);
  $('themeSelect').value = savedTheme;
}

/* =============================================================================
   COLLAPSIBLE SECTIONS
   Purpose: Expand/collapse card content for better navigation
   ============================================================================= */
function toggleCard(header) {
  const card = header.parentElement;
  card.classList.toggle('collapsed');
}

$('btnExpandAll').onclick = () => {
  document.querySelectorAll('.card').forEach(c => c.classList.remove('collapsed'));
  toast('‚ñº All sections expanded');
};

$('btnCollapseAll').onclick = () => {
  document.querySelectorAll('.card').forEach(c => c.classList.add('collapsed'));
  toast('‚ñ≤ All sections collapsed');
};

/* =============================================================================
   CLIENT-SIDE SEARCH
   Purpose: Filter visible cards based on search query
   ============================================================================= */
$('searchInput').oninput = e => {
  const query = e.target.value.toLowerCase();
  document.querySelectorAll('.card').forEach(card => {
    const text = card.textContent.toLowerCase();
    card.style.display = text.includes(query) ? '' : 'none';
  });
};

/* =============================================================================
   EXPORT FUNCTIONS
   Purpose: Save current page state as HTML, JSON, or print to PDF
   ============================================================================= */
$('btnExportHTML').onclick = () => {
  const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `peace-game-hub-${Date.now()}.html`;
  a.click();
  URL.revokeObjectURL(url);
  toast('üíæ HTML exported');
};

$('btnExportJSON').onclick = async () => {
  const data = {
    contracts: await db.getAll('contracts'),
    missions: await db.getAll('missions'),
    submissions: await db.getAll('submissions'),
    analytics: await db.getAll('analytics'),
    exportDate: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `peace-game-data-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('üìÑ JSON exported');
};

$('btnPrint').onclick = () => {
  window.print();
  toast('üñ®Ô∏è Print dialog opened');
};

/* =============================================================================
   INITIALIZATION
   Purpose: Set up IndexedDB, load initial data, start analytics
   ============================================================================= */
(async function init() {
  try {
    await db.init();
    await renderRegistry();
    await updateLeaderboards();
    await analytics.updateDashboard();
    await analytics.track('session_start');
    console.log('‚úÖ Peace Game Hub initialized');
  } catch (e) {
    console.error('‚ùå Initialization error:', e);
    toast('‚ö†Ô∏è Some features may be unavailable (IndexedDB)');
  }
})();

/* =============================================================================
   ZERO-HARM CONSOLE MESSAGE
   Purpose: Remind developers of ethical constraints
   ============================================================================= */
console.log('%cüïäÔ∏è Peace Game Hub', 'font-size:20px;color:#5ee1a0;font-weight:bold');
console.log('%cThis platform is designed for peaceful conflict resolution and humanitarian coordination.', 'font-size:14px;color:#98a6c7');
console.log('%cAny attempt to weaponize, misuse, or repurpose for harm is prohibited.', 'font-size:14px;color:#ff6b7a;font-weight:bold');
console.log('%cAll actions are rate-limited and logged locally.', 'font-size:12px;color:#98a6c7');

</script>

<!-- ============================================================================
     HTML COMMENT: ZERO-HARM DEVELOPER NOTE
     Purpose: Embedded documentation of safety principles
     ============================================================================ -->
<!--
ZERO-HARM DEVELOPER NOTE

This Peace Game Hub is designed with explicit anti-weaponization safeguards:

1. INTENDED USE: Peaceful conflict resolution, humanitarian aid coordination,
   transparent impact verification in crisis zones.

2. PROHIBITED USES: 
   - Surveillance or targeting of individuals/groups
   - Manipulation of evidence for disinformation
   - Any application causing harm to people, communities, or ecosystems

3. SAFETY FEATURES:
   - Client-side rate limiting (10 actions per 10 minutes per type)
   - Input sanitization to prevent XSS/injection
   - Local-only data storage (IndexedDB, no external tracking)
   - Dual-hash evidence verification (tamper-evident)

4. EXTENSIBILITY:
   - All code sections have inline tooltips for future expansion
   - Modular architecture supports plugin-style additions
   - Theme system easily customizable

5. LICENSE COMPLIANCE:
   - Ethers.js: MIT License
   - BLAKE3: CC0-1.0 / Apache-2.0
   - Web3 patterns: Ethereum.org CC-BY

For questions or concerns about ethical use, contact:
admin@planetaryrestorationarchive.com

Built with the conviction that technology can amplify peace, not harm.
-->

</body>
</html>